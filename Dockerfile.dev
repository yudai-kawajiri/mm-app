FROM ruby:3.3.6

ENV LANG=C.UTF-8 \
    TZ=Asia/Tokyo

# Node.js/Yarn公式リポジトリ追加
RUN apt-get update -qq \
    && apt-get install -y ca-certificates curl gnupg \
    && mkdir -p /etc/apt/keyrings \
    # Node.js 20
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
    && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list \
    # Yarn
    && curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | gpg --dearmor -o /usr/share/keyrings/yarnkey.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/yarnkey.gpg] https://dl.yarnpkg.com/debian stable main" | tee /etc/apt/sources.list.d/yarn.list

# 開発パッケージインストール
RUN apt-get update -qq && apt-get install -y \
    build-essential \
    libpq-dev \
    nodejs \
    yarn \
    vim \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /myapp

# Gemfileを先にコピーしてbundle install（キャッシュ効率化）
COPY Gemfile Gemfile.lock /myapp/
RUN gem install bundler && bundle install

# package.jsonを先にコピーしてyarn install（キャッシュ効率化）
COPY package.json yarn.lock /myapp/
RUN yarn install --check-files

# アプリケーションファイル全体をコピー
COPY . /myapp
