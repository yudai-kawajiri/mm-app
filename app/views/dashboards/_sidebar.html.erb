<div class="col-md-3 bg-light border-end p-4">
  <h2 class="mb-4 fw-bold text-primary">
    <%= t('dashboard.menu.title') %>
  </h2>

  <%#
    システム管理者: 会社選択 + 店舗選択（グレーアウト）
    会社管理者: 会社固定 + 店舗選択（全店舗選択可能）
    店舗管理者・一般ユーザー: 会社固定 + 店舗固定
  %>
  <div class="mb-3 p-3 bg-white border rounded">
    <%# === 会社選択 === %>
    <div class="mb-2">
      <small class="text-muted d-block mb-1">
        <i class="bi bi-building"></i> <%= t('dashboard.sidebar.company') %>
      </small>

      <% if current_user.super_admin? %>
        <%# システム管理者: 会社選択ドロップダウン %>
        <%= form_with url: switch_company_path, method: :post, local: true do |f| %>
          <%= f.select :current_company_id,
              options_for_select(
                [[t('dashboard.sidebar.system_admin_mode'), nil]] + Company.order(:name).pluck(:name, :id),
                session[:current_company_id].presence
              ),
              {},
              {
                class: "form-select form-select-sm",
                onchange: "this.form.submit()"
              } %>
        <% end %>
      <% else %>
        <%# 会社管理者以下: 会社名を固定表示 %>
        <div class="fw-semibold"><%= current_company&.name %></div>
      <% end %>
    </div>
    <%# === 店舗選択 === %>
    <% if current_user.super_admin? %>
      <%
        # システム管理テナント(subdomain: 'admin')の場合はグレーアウト
        current_company_obj = session[:current_company_id].present? ? Company.find_by(id: session[:current_company_id]) : nil
        is_system_company = current_company_obj&.subdomain == 'admin'
        can_select_store = session[:current_company_id].present? && !is_system_company
      %>

      <% if can_select_store %>
        <%# 一般会社選択時のみ店舗選択可能 %>
        <div>
          <small class="text-muted d-block mb-1">
            <i class="bi bi-shop"></i> <%= t('dashboard.sidebar.store') %>
          </small>
          <%= form_with url: switch_store_path, method: :post, local: true do |f| %>
            <%= f.select :current_store_id,
                options_for_select(
                  [[t('dashboard.sidebar.all_stores'), '']] + current_company.stores.map { |s| [s.name, s.id] },
                  session[:current_store_id]
                ),
                {},
                { class: 'form-select form-select-sm', onchange: 'this.form.submit();' } %>
          <% end %>
        </div>
      <% else %>
        <%# テナント未選択 or システム管理テナント: グレーアウト %>
        <div>
          <small class="text-muted d-block mb-1">
            <i class="bi bi-shop"></i> <%= t('dashboard.sidebar.store') %>
          </small>
          <select class="form-select form-select-sm" disabled>
            <option><%= t('dashboard.sidebar.select_company_first') %></option>
          </select>
          <small class="text-muted"><%= t('dashboard.sidebar.store_selection_note') %></small>
        </div>
      <% end %>
    <% elsif current_user.company_admin? %>
      <%# 会社管理者: 店舗選択可能 %>
      <div>
        <small class="text-muted d-block mb-1">
          <i class="bi bi-shop"></i> <%= t('dashboard.sidebar.store') %>
        </small>
        <%= form_with url: switch_store_path, method: :post, local: true do |f| %>
          <%= f.select :current_store_id,
              options_for_select(
                [[t('dashboard.sidebar.all_stores'), '']] + current_company.stores.map { |s| [s.name, s.id] },
                session[:current_store_id]
              ),
              {},
              { class: 'form-select form-select-sm', onchange: 'this.form.submit();' } %>
        <% end %>
      </div>
    <% else %>
      <%# 店舗管理者・一般: 店舗固定表示 %>
      <div>
        <small class="text-muted d-block mb-1">
          <i class="bi bi-shop"></i> <%= t('dashboard.sidebar.store') %>
        </small>
        <div class="fw-semibold"><%= current_user.store&.name || t('dashboard.sidebar.no_store') %></div>
      </div>
    <% end %>
  </div>

  <%# === メニュー === %>
  <div class="list-group" id="sidebar-accordion">
    <% sidebar_menu_items.each do |item| %>
      <% if item[:submenu] %>
        <%# サブメニューがある項目 %>
        <% collapse_id = "collapse-#{item[:name].parameterize}" %>
        <% parent_is_active = item[:submenu].any? { |sub| sidebar_link_active?(sub) } %>

        <% if item[:disabled] %>
      <a href="#" class="list-group-item list-group-item-action <%= 'active' if parent_is_active %> disabled text-muted" title="<%= t('dashboard.menu.disabled_menu') %>" onclick="return false;">
        <i class="<%= item[:icon] %>"></i> <%= item[:name] %>
        <i class="bi bi-lock-fill float-end"></i>
      </a>
    <% else %>
      <a href="#"
         class="list-group-item list-group-item-action <%= 'active' if parent_is_active %>"
         data-bs-toggle="collapse"
         data-bs-target="#<%= collapse_id %>"
         role="button"
         aria-expanded="<%= parent_is_active %>"
         aria-controls="<%= collapse_id %>"
         onclick="event.preventDefault();">
        <i class="<%= item[:icon] %>"></i> <%= item[:name] %>
        <i class="bi bi-chevron-down float-end"></i>
      </a>
    <% end %>

        <% unless item[:disabled] %>
        <div class="collapse <%= 'show' if parent_is_active %>"
             id="<%= collapse_id %>"
             data-bs-parent="#sidebar-accordion">
          <% item[:submenu].each do |sub_item| %>
            <% if sub_item[:submenu] %>
              <%# 3階層目のサブメニュー %>
              <% sub_collapse_id = "collapse-#{sub_item[:name].parameterize}" %>
              <% sub_parent_is_active = sub_item[:submenu].any? { |s| sidebar_link_active?(s) } %>

              <a href="#"
                 class="list-group-item list-group-item-action ps-4 <%= 'active' if sub_parent_is_active %>"
                 data-bs-toggle="collapse"
                 data-bs-target="#<%= sub_collapse_id %>"
                 role="button"
                 aria-expanded="<%= sub_parent_is_active %>"
                 aria-controls="<%= sub_collapse_id %>"
                 onclick="event.preventDefault();">
                <%= submenu_indicator %><%= sub_item[:name] %>
                <i class="bi bi-chevron-down float-end"></i>
              </a>

              <div class="collapse <%= 'show' if sub_parent_is_active %>"
                   id="<%= sub_collapse_id %>"
                   data-bs-parent="#<%= collapse_id %>">
                <% sub_item[:submenu].each do |third_item| %>
                  <%= link_to third_item[:path],
                      class: "list-group-item list-group-item-action ps-5 #{sidebar_link_active?(third_item) ? 'active' : ''}" do %>
                    <%= submenu_indicator %><%= third_item[:name] %>
                  <% end %>
                <% end %>
              </div>
            <% else %>
              <%# 2階層目のサブメニュー %>
              <% if sub_item[:disabled] %>
                <a href="#" class="list-group-item list-group-item-action ps-4 disabled text-muted" title="<%= t('dashboard.menu.disabled_menu') %>" onclick="return false;">
                  <%= submenu_indicator %><%= sub_item[:name] %>
                  <i class="bi bi-lock-fill float-end"></i>
                </a>
              <% else %>
                <%= link_to sub_item[:path],
                    class: sidebar_submenu_link_class(sub_item[:path]) do %>
                  <%= submenu_indicator %><%= sub_item[:name] %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        </div>
        <% end %>
      <% else %>
        <%# サブメニューがない項目（ダッシュボードなど） %>
        <% item_is_active = sidebar_link_active?(item) %>
        <%= link_to item[:name], item[:path],
            class: "list-group-item list-group-item-action #{'active' if item_is_active}" %>
      <% end %>
    <% end %>

    <hr>

    <%# 設定メニュー: アカウント設定、ヘルプ、利用規約など %>
    <% settings_collapse_id = 'collapse-settings' %>
    <% settings_is_active = current_page?(help_path) || current_page?(edit_user_registration_path) || current_page?(terms_path) || current_page?(privacy_path) || current_page?(new_contact_path) %>

    <a href="#"
        class="list-group-item list-group-item-action <%= 'active' if settings_is_active %>"
        data-bs-toggle="collapse"
        data-bs-target="#<%= settings_collapse_id %>"
        role="button"
        aria-expanded="<%= settings_is_active %>"
        aria-controls="<%= settings_collapse_id %>"
        onclick="event.preventDefault();">
      <i class="bi bi-gear"></i> <%= t('dashboard.menu.settings') %>
      <i class="bi bi-chevron-down float-end"></i>
    </a>

    <div class="collapse <%= 'show' if settings_is_active %>"
          id="<%= settings_collapse_id %>"
          data-bs-parent="#sidebar-accordion">

      <%= link_to edit_user_registration_path,
          class: "list-group-item list-group-item-action ps-4 #{current_page?(edit_user_registration_path) ? 'active' : ''}" do %>
        <%= submenu_indicator %><%= t('dashboard.menu.account_settings') %>
      <% end %>

      <%= link_to help_path,
          class: "list-group-item list-group-item-action ps-4 #{current_page?(help_path) ? 'active' : ''}" do %>
        <%= submenu_indicator %><%= t('dashboard.menu.help') %>
      <% end %>

      <%= link_to new_contact_path,
          class: "list-group-item list-group-item-action ps-4 #{current_page?(new_contact_path) ? 'active' : ''}" do %>
        <%= submenu_indicator %><%= t('dashboard.menu.contact') %>
      <% end %>

      <%= link_to terms_path,
          class: "list-group-item list-group-item-action ps-4 #{current_page?(terms_path) ? 'active' : ''}" do %>
        <%= submenu_indicator %><%= t('dashboard.menu.terms') %>
      <% end %>

      <%= link_to privacy_path,
          class: "list-group-item list-group-item-action ps-4 #{current_page?(privacy_path) ? 'active' : ''}" do %>
        <%= submenu_indicator %><%= t('dashboard.menu.privacy_policy') %>
      <% end %>
    </div>

    <%= button_to destroy_user_session_path, method: :delete, data: { turbo: false }, class: "list-group-item list-group-item-action text-danger mt-2" do %>
      <%= t('devise.sessions.sign_out') %>
    <% end %>

  </div>
</div>
