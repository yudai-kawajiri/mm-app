<%#
  機能: 計画割当モーダル（新規作成・編集）

  JavaScript機能:
  - setAssignPlanModalData: 新規/編集モードの切り替え
  - handleCategoryChange: カテゴリ選択時に計画リストを動的に追加
  - handlePlanChange: 計画選択時に売上額を自動設定
%>

<div class="modal fade"
      id="assignPlanModal"
      tabindex="-1"
      aria-labelledby="assignPlanModalLabel"
      aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with model: Planning::PlanSchedule.new,
                    scope: :plan_schedule,
                    url: management_plan_schedules_path,
                    method: :post,
                    local: true do |f| %>
        <div class="modal-header">
          <h5 class="modal-title" id="assignPlanModalLabel"><%= t("numerical_managements.modals.assign_plan.title") %></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <%= f.hidden_field :scheduled_date, id: "assignPlanDateHidden" %>

          <div class="mb-3">
            <label class="form-label"><%= t('numerical_managements.modals.labels.target_date') %></label>
            <input type="text" class="form-control-plaintext" id="assignPlanDate" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label"><%= t('numerical_managements.modals.labels.category') %></label>
            <select class="form-select"
                    id="assignPlanCategory"
                    onchange="handleCategoryChange(this)">
              <option value=""><%= t('numerical_managements.modals.prompts.select_category') %></option>
              <% if @plans_by_category.present? %>
                <% @plans_by_category.keys.sort.each do |category_name| %>
                  <option value="<%= category_name %>"><%= category_name %></option>
                <% end %>
              <% end %>
            </select>
          </div>

          <div class="mb-3">
            <%= f.label :plan_id, t('numerical_managements.modals.labels.plan_select'), class: "form-label" %>
            <select name="plan_schedule[plan_id]"
                    class="form-select"
                    id="assignPlanSelect"
                    onchange="handlePlanChange(this)"
                    disabled
                    required>
              <option value=""><%= t('numerical_managements.modals.prompts.select_plan_after_category') %></option>
            </select>
          </div>

          <div class="mb-3">
            <%= f.label :planned_revenue, t('numerical_managements.modals.labels.planned_revenue_yen'), class: "form-label" %>
            <%= f.text_field :planned_revenue,
              class: "form-control-plaintext",
              id: "assignPlanAmount",
              readonly: true,
              data: {
                controller: 'number-input',
                action: 'input->number-input#handleInput paste->number-input#handlePaste'
              } %>
            <%= f.hidden_field :planned_revenue, id: "assignPlanAmountHidden" %>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= t('common.cancel') %></button>
          <%= f.submit t('common.create'), id: 'assignPlanSubmitBtn', class: "btn btn-primary", data: { disable_with: t('common.saving') } %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
window.plansByCategory = <%= raw @plans_by_category.transform_values { |plans|
  plans.map { |p| { id: p.id, name: p.name, expected_revenue: p.expected_revenue } }
}.to_json %>;

window.assignPlanI18n = {
  createLabel: '<%= j t("common.create") %>',
  updateLabel: '<%= j t("common.update") %>',
  editTitle: '<%= j t('numerical_managements.modals.assign_plan.edit_title') %>',
  addTitle: '<%= j t('numerical_managements.modals.assign_plan.title') %>',
  selectPlanPrompt: '<%= j t('numerical_managements.modals.prompts.select_plan') %>',
  selectPlanAfterCategory: '<%= j t('numerical_managements.modals.prompts.select_plan_after_category') %>'
};

function setAssignPlanModalData(button) {
  const scheduleId = button.getAttribute('data-schedule-id');
  const planId = button.getAttribute('data-plan-id');
  const categoryName = button.getAttribute('data-category-name');
  const plannedRevenue = button.getAttribute('data-planned-revenue');
  const dateDisplay = button.getAttribute('data-date-display');
  const date = button.getAttribute('data-date');

  document.getElementById('assignPlanDate').value = dateDisplay || '';
  document.getElementById('assignPlanDateHidden').value = date || '';

  const form = document.querySelector('#assignPlanModal form');
  const modalTitle = document.getElementById('assignPlanModalLabel');
  const submitBtn = document.getElementById('assignPlanSubmitBtn');

  if (scheduleId) {
    modalTitle.textContent = window.assignPlanI18n.editTitle;
    submitBtn.value = window.assignPlanI18n.updateLabel;
    form.action = '/management/plan_schedules/' + scheduleId;

    let methodInput = form.querySelector('input[name="_method"]');
    if (!methodInput) {
      methodInput = document.createElement('input');
      methodInput.type = 'hidden';
      methodInput.name = '_method';
      form.appendChild(methodInput);
    }
    methodInput.value = 'patch';

    if (categoryName) {
      document.getElementById('assignPlanCategory').value = categoryName;
      handleCategoryChange(document.getElementById('assignPlanCategory'));

      setTimeout(() => {
        if (planId) {
          document.getElementById('assignPlanSelect').value = planId;
          handlePlanChange(document.getElementById('assignPlanSelect'));
        }
      }, 50);
    }

    document.getElementById('assignPlanAmount').value = plannedRevenue || 0;
    document.getElementById("assignPlanAmountHidden").value = plannedRevenue || 0;
  } else {
    modalTitle.textContent = window.assignPlanI18n.addTitle;
    submitBtn.value = window.assignPlanI18n.createLabel;
    form.action = '<%= management_plan_schedules_path %>';

    const methodInput = form.querySelector('input[name="_method"]');
    if (methodInput) {
      methodInput.remove();
    }

    document.getElementById('assignPlanCategory').value = '';
    const planSelect = document.getElementById('assignPlanSelect');
    planSelect.innerHTML = `<option value="">${window.assignPlanI18n.selectPlanAfterCategory}</option>`;
    planSelect.disabled = true;
    document.getElementById('assignPlanAmount').value = '';
    document.getElementById('assignPlanAmountHidden').value = '';
  }
}

function handleCategoryChange(select) {
  const category = select.value;
  const planSelect = document.getElementById('assignPlanSelect');

  if (!category) {
    planSelect.innerHTML = `<option value="">${window.assignPlanI18n.selectPlanAfterCategory}</option>`;
    planSelect.disabled = true;
    document.getElementById('assignPlanAmount').value = '';
    document.getElementById('assignPlanAmountHidden').value = '';
    return;
  }

  planSelect.innerHTML = `<option value="">${window.assignPlanI18n.selectPlanPrompt}</option>`;

  const plans = window.plansByCategory[category];

  if (!plans || plans.length === 0) {
    planSelect.disabled = true;
    return;
  }

  plans.forEach(plan => {
    const option = document.createElement('option');
    option.value = plan.id;
    option.textContent = plan.name;
    option.dataset.revenue = plan.expected_revenue || 0;
    planSelect.appendChild(option);
  });

  planSelect.disabled = false;
}

function handlePlanChange(select) {
  const selectedOption = select.selectedOptions[0];
  if (selectedOption && selectedOption.value) {
    const revenue = selectedOption.dataset.revenue || 0;
    document.getElementById('assignPlanAmount').value = revenue;
    document.getElementById("assignPlanAmountHidden").value = revenue;
  } else {
    document.getElementById('assignPlanAmount').value = '';
    document.getElementById('assignPlanAmountHidden').value = '';
  }
}
</script>
