<%# 計画割当モーダル %>
<div class="modal fade"
      id="assignPlanModal"
      tabindex="-1"
      aria-labelledby="assignPlanModalLabel"
      aria-hidden="true"
      data-controller="management--assign-plan-info management--assign-plan-modal"
      data-action="show.bs.modal->management--assign-plan-info#showModal"
      data-management--assign-plan-modal-plans-value="<%= @plans_by_category.transform_values { |plans| plans.map { |p| { id: p.id, name: p.name, status: p.status, expected_revenue: p.expected_revenue, plan_products: p.plan_products.map { |pp| { product_id: pp.product_id, product_name: pp.product.name, production_count: pp.production_count, price: pp.product.price } } } } }.to_json %>"
      data-management--assign-plan-modal-i18n-select-placeholder-value="<%= t('helpers.prompt.select') %>"
      data-management--assign-plan-modal-i18n-select-plan-after-category-value="<%= t('numerical_managements.modals.prompts.select_plan_after_category') %>"
      data-management--assign-plan-modal-i18n-no-available-plans-value="<%= t('numerical_managements.modals.prompts.no_available_plans') %>"
      data-management--assign-plan-modal-i18n-alert-plan-unavailable-value="<%= t('numerical_managements.modals.assign_plan.alert_plan_unavailable') %>"
      data-management--assign-plan-modal-i18n-edit-title-value="<%= t('numerical_managements.modals.assign_plan.edit_title') %>"
      data-management--assign-plan-modal-i18n-add-title-value="<%= t('numerical_managements.modals.assign_plan.title') %>"
      data-management--assign-plan-modal-i18n-create-label-value="<%= t('common.create') %>"
      data-management--assign-plan-modal-i18n-update-label-value="<%= t('common.update') %>"
      data-management--assign-plan-modal-i18n-no-products-value="<%= t('plans.print.no_products') %>"
      data-bs-backdrop="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <%= form_with model: Planning::PlanSchedule.new,
                    scope: :plan_schedule,
                    url: management_plan_schedules_path,
                    method: :post,
                    local: true,
                    id: "assignPlanForm",
                    data: { 'management--assign-plan-modal-target': 'form' } do |f| %>
        <div class="modal-header">
          <h5 class="modal-title" id="assignPlanModalLabel" data-management--assign-plan-modal-target="modalTitle"><%= t("numerical_managements.modals.assign_plan.title") %></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <%= f.hidden_field :scheduled_date, id: "scheduledDateHidden", data: { 'management--assign-plan-modal-target': 'dateHidden' } %>

          <div class="mb-3">
            <label class="form-label"><%= t('numerical_managements.modals.labels.target_date') %></label>
            <input type="text" class="form-control-plaintext" id="assignPlanDate" readonly data-management--assign-plan-modal-target="dateDisplay">
          </div>

          <div class="mb-3">
            <label class="form-label"><%= t('numerical_managements.modals.labels.category') %></label>
            <select class="form-select"
                    id="assignPlanCategory"
                    required
                    data-management--assign-plan-modal-target="categorySelect"
                    data-action="change->management--assign-plan-modal#handleCategoryChange change->management--assign-plan-info#handleCategoryChange">
              <option value=""><%= t('helpers.prompt.select') %></option>
              <% if @plans_by_category.present? %>
                <% @plans_by_category.keys.sort.each do |category_name| %>
                  <option value="<%= category_name %>"><%= category_name %>
                <% end %>
              <% end %>
            </select>
          </div>

          <div class="mb-3">
            <%= f.label :plan_id, t('numerical_managements.modals.labels.plan_select'), class: "form-label" %>
            <select name="plan_schedule[plan_id]"
                    class="form-select"
                    id="assignPlanSelect"
                    disabled
                    required
                    data-management--assign-plan-info-target="planSelect"
                    data-management--assign-plan-modal-target="planSelect"
                    data-action="change->management--assign-plan-modal#handlePlanChange change->management--assign-plan-info#handlePlanChange">
              <option value=""><%= t('numerical_managements.modals.prompts.select_plan_after_category') %></option>
            </select>
          </div>

          <div id="productsAdjustSection" style="display: none;" data-management--assign-plan-modal-target="productsAdjustSection">
            <hr>
            <h6 class="mb-3"><%= t('numerical_managements.modals.labels.product_quantity_adjustment') %></h6>
            <div id="productsContainer" class="mb-3" data-management--assign-plan-modal-target="productsContainer">
            </div>
            <div class="alert alert-info mb-0">
              <strong><%= t('numerical_managements.modals.labels.planned_revenue') %>:</strong>
              <span id="totalCostDisplay" data-management--assign-plan-modal-target="totalCostDisplay"></span>
            </div>
          </div>

          <%= f.hidden_field :planned_revenue, id: "plannedRevenue", data: { 'management--assign-plan-modal-target': 'plannedRevenue' } %>

          <div class="alert alert-info mb-3"
               id="assignPlanInfoAlert"
               data-management--assign-plan-info-target="infoAlert"
               data-management--assign-plan-modal-target="infoAlert">
            <i class="bi bi-info-circle"></i> <%= t('numerical_managements.modals.assign_plan.info') %>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= t('common.cancel') %></button>
          <%= f.submit t('common.create'), id: 'assignPlanSubmitBtn', class: "btn btn-primary", data: { disable_with: t('common.saving'), 'management--assign-plan-modal-target': 'submitBtn' } %>
        </div>
      <% end %>
    </div>
  </div>
</div>
