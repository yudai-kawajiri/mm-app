<%# 日別明細テーブル(一括編集機能付き) %>
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><%= t('numerical_managements.index.daily_details') %></h5>
    <button type="button"
            class="btn btn-primary btn-sm"
            id="bulkEditToggleBtn">
      <i class="bi bi-pencil-square"></i> <%= t('numerical_managements.bulk_edit.toggle_edit_mode') %></button>
  </div>

  <div id="bulkEditSummary" class="card-body bg-light border-bottom" style="display: none;">
    <%
      # 日別予算の合計を計算
      daily_target_sum = daily_data.sum { |day| day[:target] || 0 }
      # 月間予算との差分を計算
      monthly_budget_amount = @monthly_budget&.target_amount || 0
      budget_diff = monthly_budget_amount - daily_target_sum
    %>
    <div class="row">
      <div class="col-md-4">
        <strong><%= t('numerical_managements.bulk_edit.monthly_budget_label') %></strong>
        <span class="text-primary"><%= format_currency(monthly_budget_amount) %></span>
      </div>
      <div class="col-md-4">
        <strong><%= t('numerical_managements.bulk_edit.daily_target_sum') %></strong>
        <span id="dailyTargetSum" class="fw-bold"><%= format_currency(daily_target_sum) %></span>
      </div>
      <div class="col-md-4">
        <strong><%= t('numerical_managements.bulk_edit.budget_diff_label') %></strong>
        <%
          diff_class = if budget_diff > 0
                        'fw-bold text-warning'
                      elsif budget_diff < 0
                        'fw-bold text-danger'
                      else
                        'fw-bold text-success'
                      end
          diff_text = if budget_diff > 0
                        "-#{format_currency(budget_diff.abs)} #{t('numerical_managements.bulk_edit.shortage')}"
                      elsif budget_diff < 0
                        "+#{format_currency(budget_diff.abs)} #{t('numerical_managements.bulk_edit.excess')}"
                      else
                        format_currency(0)
                      end
        %>
        <span id="budgetDiff" class="<%= diff_class %>"><%= diff_text %></span>
      </div>
    </div>
  </div>

  <div class="card-body p-0">
    <%= form_with url: bulk_update_management_numerical_managements_path, method: :patch, id: "bulkEditForm" do |f| %>
      <%= hidden_field_tag :year, @selected_date.year %>
      <%= hidden_field_tag :month, @selected_date.month %>

      <div style="max-height: 500px; overflow-y: auto;">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light sticky-top">
            <tr>
              <th style="width: 80px;"><%= t('labels.date') %></th>
              <th class="text-end" style="width: 100px;"><%= t('numerical_managements.table_headers.budget') %></th>
              <th class="text-end" style="width: 100px;"><%= t('numerical_managements.table_headers.planned') %></th>
              <th class="text-end" style="width: 100px;"><%= t('numerical_managements.table_headers.actual') %></th>
              <th class="text-end" style="width: 80px;"><%= t('numerical_managements.table_headers.achievement_rate') %></th>
              <th class="text-end" style="width: 100px;"><%= t('numerical_managements.table_headers.budget_diff') %></th>
              <th class="text-center bulk-edit-hidden" style="width: 180px;"><%= t('common.action') %></th>
            </tr>
          </thead>
          <tbody>
            <% daily_data.each_with_index do |day, index| %>
              <%
                daily_target = @daily_targets[day[:date].day]
                target_id = daily_target&.id
                is_past = day[:date] < Date.current
              %>

              <tr class="<%= 'table-secondary' unless is_past %>">
                <td style="width: 80px;" rowspan="2" class="align-middle">
                  <%= day[:date].strftime('%-m/%-d') %>
                </td>

                <td class="text-end">
                  <span class="normal-mode-display">
                    <%= format_currency(day[:target] || 0) %>
                  </span>
                  <div class="bulk-edit-input" style="display: none;">
                    <%= text_field_tag "daily_data[#{index}][target_amount]",
                              number_with_delimiter(day[:target].to_i),
                              class: "form-control form-control-sm text-end bulk-edit-target",
                              data: {
                        controller: "input--number-input",
                        action: "input->input--number-input#handleInput paste->input--number-input#handlePaste focus->input--number-input#handleFocus blur->input--number-input#handleBlur",
                        original: day[:target].to_i
                      },
                              placeholder: "0",
                              inputmode: "numeric" %>
                    <%= hidden_field_tag "daily_data[#{index}][date]", day[:date].strftime('%Y-%m-%d') %>
                    <%= hidden_field_tag "daily_data[#{index}][target_id]", target_id %>
                  </div>
                </td>

                <td class="text-end">
                  <%= format_currency(day[:planned] || 0) %>
                </td>

                <td class="text-end">
                  <span class="normal-mode-display">
                    <%= format_currency(day[:actual] || 0) %>
                  </span>
                  <div class="bulk-edit-input" style="display: none;">
                    <% first_schedule = day[:plan_schedules].first %>
                    <%= text_field_tag "daily_data[#{index}][actual_revenue]",
                              number_with_delimiter((first_schedule&.actual_revenue || 0).to_i),
                              class: "form-control form-control-sm text-end",
                              data: {
                                controller: "input--number-input",
                                action: "input->input--number-input#handleInput paste->input--number-input#handlePaste focus->input--number-input#handleFocus blur->input--number-input#handleBlur"
                              },
                              disabled: day[:plan_schedules].empty?,
                              placeholder: "0",
                              inputmode: "numeric" %>
                    <%= hidden_field_tag "daily_data[#{index}][plan_schedule_id]", first_schedule&.id %>
                  </div>
                </td>

                <td class="text-end">
                  <% rate = day[:achievement_rate] || 0 %>
                  <span class="<%= rate >= 100 ? 'text-success' : (rate >= 80 ? 'text-warning' : 'text-danger') %>">
                    <%= number_to_percentage(rate, precision: 1) %>
                  </span>
                </td>

                <td class="text-end <%= (day[:diff] || 0) >= 0 ? 'text-success' : 'text-danger' %>">
                  <%= format_currency(day[:diff] || 0) %>
                </td>

                <td class="text-center bulk-edit-hidden" rowspan="2" class="align-middle">
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#editDailyTargetModal"
                            data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                            data-date-display="<%= day[:date].strftime('%-m月%-d日') %>"
                            data-target-id="<%= target_id %>"
                            data-target-amount="<%= day[:target].to_i %>"
                            onclick="setEditModalData(this)"
                            title="<%= t('numerical_managements.actions.edit_target') %>">
                      <i class="bi bi-pencil"></i>
                    </button>

                    <% first_schedule = day[:plan_schedules].first %>
                    <button type="button"
                            class="btn <%= first_schedule ? 'btn-outline-warning' : 'btn-outline-info' %> plan-add-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#assignPlanModal"
                            data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                            data-date-display="<%= day[:date].strftime('%-m月%-d日') %>"
                            data-year="<%= day[:date].year %>"
                            data-month="<%= day[:date].month %>"
                            data-day="<%= day[:date].day %>"
                            data-schedule-id="<%= first_schedule&.id %>"
                            data-plan-id="<%= first_schedule&.plan_id %>"
                            data-plan-name="<%= first_schedule&.plan&.name %>"
                            data-category-name="<%= first_schedule&.plan&.category&.name %>"
                            data-planned-revenue="<%= first_schedule&.snapshot_total_cost || 0 %>"
                            data-snapshot="<%= first_schedule&.snapshot_products_for_json&.to_json %>"
                            onclick="setAssignPlanModalData(this)"
                            title="<%= first_schedule ? t('numerical_managements.actions.edit_plan') : t('numerical_managements.actions.add_plan') %>">
                      <i class="bi bi-<%= first_schedule ? 'pencil-square' : 'calendar-plus' %>"></i>
                    </button>

                    <% if day[:plan_schedules].present? %>
                      <% first_schedule = day[:plan_schedules].first %>
                      <button type="button"
                              class="btn btn-outline-success"
                              data-bs-toggle="modal"
                              data-bs-target="#actualRevenueModal"
                              data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                              data-date-display="<%= day[:date].strftime('%-m月%-d日') %>"
                              data-plan-schedule-id="<%= first_schedule.id %>"
                              data-actual-revenue="<%= (first_schedule.actual_revenue || 0).to_i %>"
                              onclick="setActualModalData(this)"
                              title="<%= t('numerical_managements.actions.input_actual') %>">
                        <i class="bi bi-currency-yen"></i>
                      </button>
                    <% end %>

                    <% if day[:plan_schedules].present? %>
                      <% if day[:plan_schedules].count == 1 %>
                        <%= link_to "/resources/plans/#{day[:plan_schedules].first.plan.id}/print?date=#{day[:date]}",
                                    class: "btn btn-outline-primary",
                                    target: "_blank",
                                    data: { turbo: false },
                                    title: t('numerical_managements.actions.print_plan') do %>
                          <i class="bi bi-printer"></i>
                        <% end %>
                      <% else %>
                        <div class="btn-group" role="group">
                          <button type="button"
                                  class="btn btn-outline-primary dropdown-toggle"
                                  data-bs-toggle="dropdown"
                                  aria-expanded="false"
                                  title="<%= t('numerical_managements.actions.select_plan_to_print') %>">
                            <i class="bi bi-printer"></i>
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <% day[:plan_schedules].each do |ps| %>
                              <li>
                                <%= link_to "/resources/plans/#{ps.plan.id}/print?date=#{day[:date]}",
                                            class: "dropdown-item",
                                            target: "_blank",
                                            data: { turbo: false } do %>
                                  <%= ps.plan.name %>
                                <% end %>
                              </li>
                            <% end %>
                          </ul>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>

              <tr class="table-light <%= 'table-secondary' unless is_past %>">
                <td class="text-end">
                  <small class="text-muted"><%= t('numerical_managements.labels.cumulative') %></small>
                  <%= format_currency(day[:cumulative_target] || 0) %>
                </td>

                <td class="text-end">
                  <small class="text-muted"><%= t('numerical_managements.labels.cumulative') %></small>
                  <%= format_currency(day[:cumulative_planned] || 0) %>
                </td>

                <td class="text-end">
                  <small class="text-muted"><%= t('numerical_managements.labels.cumulative') %></small>
                  <%= format_currency(day[:cumulative_actual] || 0) %>
                </td>

                <td class="text-end">
                  <% cum_rate = day[:cumulative_achievement_rate] || 0 %>
                  <small class="text-muted"><%= t('numerical_managements.labels.cumulative') %></small>
                  <span class="<%= cum_rate >= 100 ? 'text-success' : (cum_rate >= 80 ? 'text-warning' : 'text-danger') %>">
                    <%= number_to_percentage(cum_rate, precision: 1) %>
                  </span>
                </td>

                <td class="text-end <%= (day[:cumulative_diff] || 0) >= 0 ? 'text-success' : 'text-danger' %>">
                  <small class="text-muted"><%= t('numerical_managements.labels.cumulative') %></small>
                  <%= format_currency(day[:cumulative_diff] || 0) %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="card-footer bulk-edit-actions" style="display: none;">
        <div class="d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-secondary" id="bulkEditCancelBtn">
            <i class="bi bi-x-lg"></i> <%= t('common.cancel') %>
          </button>
          <button type="submit" class="btn btn-success" id="bulkSaveButton">
            <i class="bi bi-check-lg"></i> <%= t('numerical_managements.bulk_edit.bulk_save') %>
          </button>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
window.isEditMode = false;
window.monthlyBudget = <%= @monthly_budget&.target_amount || 0 %>;

function setupNumericInput(input) {
  let isComposing = false;

  const initialValue = input.value.replace(/,/g, '');
  input.dataset.rawValue = initialValue || '0';

  input.addEventListener('compositionstart', function() {
    isComposing = true;
  });

  input.addEventListener('compositionend', function(e) {
    isComposing = false;
    processInput(e.target);
  });

  input.addEventListener('focus', function(e) {
    const rawValue = e.target.dataset.rawValue || '0';
    e.target.value = rawValue;

    setTimeout(function() {
      const len = e.target.value.length;
      e.target.setSelectionRange(len, len);
    }, 0);
  });

  input.addEventListener('input', function(e) {
    if (isComposing) {
      return;
    }

    processInput(e.target);
  });

  input.addEventListener('blur', function(e) {
    let rawValue = e.target.dataset.rawValue || '';

    if (rawValue === '' || rawValue === '0') {
      rawValue = '0';
      e.target.dataset.rawValue = '0';
    }

    const numValue = parseInt(rawValue, 10) || 0;
    e.target.value = rawValue;
  });

  function processInput(input) {
    const originalValue = input.value;
    const originalCursorPos = input.selectionStart;

    let value = originalValue;

    value = value.replace(/[０-９]/g, function(s) {
      return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    });

    value = value.replace(/[^\d]/g, '');

    if (value.length > 1) {
      value = value.replace(/^0+/, '');
    }

    if (input.value !== value) {
      let digitsBeforeCursor = 0;
      for (let i = 0; i < originalCursorPos && i < originalValue.length; i++) {
        if (/\d/.test(originalValue[i])) {
          digitsBeforeCursor++;
        }
      }

      input.value = value;

      let newPos = 0;
      let digitCount = 0;
      for (let i = 0; i < value.length; i++) {
        if (digitCount >= digitsBeforeCursor) {
          break;
        }
        newPos++;
        digitCount++;
      }

      input.setSelectionRange(newPos, newPos);
    }

    input.dataset.rawValue = value;

    if (input.classList.contains('bulk-edit-target')) {
      calculateDailyTargetSum();
    }
  }
}

function toggleBulkEditMode() {
  window.isEditMode = !window.isEditMode;

  if (window.isEditMode) {
    document.getElementById('bulkEditToggleBtn').innerHTML = '<i class="bi bi-eye"></i> <%= j t('numerical_managements.bulk_edit.toggle_normal_mode') %>';
    document.getElementById('bulkEditSummary').style.display = 'block';
    document.querySelectorAll('.normal-mode-display').forEach(function(el) {
      el.style.display = 'none';
    });
    document.querySelectorAll('.bulk-edit-input').forEach(function(el) {
      el.style.display = 'block';
    });
    document.querySelectorAll('.bulk-edit-hidden').forEach(function(el) {
      el.style.display = 'none';
    });
    document.querySelector('.bulk-edit-actions').style.display = 'block';

    document.querySelectorAll('.numeric-input').forEach(function(input) {
      const newInput = document.createElement('input');
      newInput.type = 'text';
      newInput.value = input.value;
      newInput.className = input.className;
      newInput.name = input.name;
      newInput.placeholder = input.placeholder || '';
      newInput.disabled = input.disabled;

      if (input.dataset.original) {
        newInput.dataset.original = input.dataset.original;
      }

      input.parentNode.replaceChild(newInput, input);

      setupNumericInput(newInput);
    });

    calculateDailyTargetSum();
  } else {
    document.getElementById('bulkEditToggleBtn').innerHTML = '<i class="bi bi-pencil-square"></i> <%= j t('numerical_managements.bulk_edit.toggle_edit_mode') %>';
    document.getElementById('bulkEditSummary').style.display = 'none';
    document.querySelectorAll('.normal-mode-display').forEach(function(el) {
      el.style.display = 'inline';
    });
    document.querySelectorAll('.bulk-edit-input').forEach(function(el) {
      el.style.display = 'none';
    });
    document.querySelectorAll('.bulk-edit-hidden').forEach(function(el) {
      el.style.display = 'table-cell';
    });
    document.querySelector('.bulk-edit-actions').style.display = 'none';

    document.querySelectorAll('.bulk-edit-target').forEach(function(input) {
      const originalValue = parseInt(input.dataset.original, 10) || 0;
      input.dataset.rawValue = originalValue.toString();
      input.value = originalValue.toString();
    });
  }
}

function calculateDailyTargetSum() {
  let sum = 0;
  let cumulativeTarget = 0;
  let cumulativePlanned = 0;
  let cumulativeActual = 0;

  document.querySelectorAll('.bulk-edit-target').forEach(function(input) {
    const value = parseInt(input.dataset.rawValue, 10) || 0;
    sum += value;
    cumulativeTarget += value;

    const currentRow = input.closest('tr');
    if (currentRow) {
      const plannedCell = currentRow.querySelector('td:nth-child(3)');
      const plannedValue = plannedCell ? parseInt(plannedCell.textContent.replace(/[^0-9]/g, ''), 10) || 0 : 0;
      cumulativePlanned += plannedValue;

      const actualCell = currentRow.querySelector('td:nth-child(4)');
      let actualValue = 0;
      if (actualCell) {
        const actualInput = actualCell.querySelector('.numeric-input');
        if (actualInput && !actualInput.disabled) {
          actualValue = parseInt(actualInput.dataset.rawValue, 10) || 0;
        } else {
          const displaySpan = actualCell.querySelector('.normal-mode-display');
          if (displaySpan) {
            actualValue = parseInt(displaySpan.textContent.replace(/[^0-9]/g, ''), 10) || 0;
          }
        }
      }
      cumulativeActual += actualValue;

      const cumulativeRow = currentRow.nextElementSibling;

      if (cumulativeRow && cumulativeRow.classList.contains('table-light')) {
        updateCumulativeCell(cumulativeRow, 1, cumulativeTarget);
        updateCumulativeCell(cumulativeRow, 2, cumulativePlanned);
        updateCumulativeCell(cumulativeRow, 3, cumulativeActual);

        const cumulativeRateCell = cumulativeRow.querySelector('td:nth-child(4)');
        if (cumulativeRateCell) {
          let rate = 0;
          if (cumulativeTarget > 0) {
            rate = (cumulativeActual / cumulativeTarget) * 100;
          }

          const rateSpan = cumulativeRateCell.querySelector('span');
          if (rateSpan) {
            rateSpan.className = '';
            if (rate >= 100) {
              rateSpan.classList.add('text-success');
            } else if (rate >= 80) {
              rateSpan.classList.add('text-warning');
            } else {
              rateSpan.classList.add('text-danger');
            }
            rateSpan.textContent = rate.toFixed(1) + '%';
          }
        }

        const cumulativeDiffCell = cumulativeRow.querySelector('td:nth-child(5)');
        if (cumulativeDiffCell) {
          const diff = cumulativeActual - cumulativeTarget;
          const labelElement = cumulativeDiffCell.querySelector('small.text-muted');

          if (labelElement) {
            cumulativeDiffCell.innerHTML = '';
            cumulativeDiffCell.appendChild(labelElement.cloneNode(true));
            cumulativeDiffCell.appendChild(document.createTextNode(' ¥' + diff.toLocaleString('ja-JP')));

            cumulativeDiffCell.className = 'text-end';
            if (diff >= 0) {
              cumulativeDiffCell.classList.add('text-success');
            } else {
              cumulativeDiffCell.classList.add('text-danger');
            }
          }
        }
      }
    }
  });

  const diff = sum - window.monthlyBudget;

  document.getElementById('dailyTargetSum').textContent = '¥' + sum.toLocaleString('ja-JP');

  const diffElement = document.getElementById('budgetDiff');
  const saveButton = document.getElementById('bulkSaveButton');

  if (diff > 0) {
    diffElement.textContent = '+¥' + diff.toLocaleString('ja-JP') + ' <%= j t('numerical_managements.bulk_edit.excess') %>';
    diffElement.className = 'fw-bold text-danger';
    saveButton.disabled = true;
  } else if (diff < 0) {
    diffElement.textContent = '-¥' + Math.abs(diff).toLocaleString('ja-JP') + ' <%= j t('numerical_managements.bulk_edit.shortage') %>';
    diffElement.className = 'fw-bold text-warning';
    saveButton.disabled = false;
  } else {
    diffElement.textContent = '¥0';
    diffElement.className = 'fw-bold text-success';
    saveButton.disabled = false;
  }
}

function updateCumulativeCell(row, columnIndex, value) {
  const cell = row.querySelector('td:nth-child(' + columnIndex + ')');
  if (cell) {
    const labelElement = cell.querySelector('small.text-muted');
    if (labelElement) {
      cell.innerHTML = '';
      cell.appendChild(labelElement.cloneNode(true));
      cell.appendChild(document.createTextNode(' ¥' + value.toLocaleString('ja-JP')));
    }
  }
}

function initializeCumulativeValues() {
  let cumulativeTarget = 0;
  let cumulativePlanned = 0;
  let cumulativeActual = 0;

  document.querySelectorAll('tbody tr').forEach(function(row) {
    const dateCell = row.querySelector('td[rowspan="2"]');
    if (!dateCell) {
      return;
    }

    const budgetCell = row.querySelector('td:nth-child(2) .normal-mode-display');
    const budgetValue = budgetCell ? parseInt(budgetCell.textContent.replace(/[^0-9]/g, ''), 10) || 0 : 0;
    cumulativeTarget += budgetValue;

    const plannedCell = row.querySelector('td:nth-child(3)');
    const plannedValue = plannedCell ? parseInt(plannedCell.textContent.replace(/[^0-9]/g, ''), 10) || 0 : 0;
    cumulativePlanned += plannedValue;

    const actualCell = row.querySelector('td:nth-child(4) .normal-mode-display');
    const actualValue = actualCell ? parseInt(actualCell.textContent.replace(/[^0-9]/g, ''), 10) || 0 : 0;
    cumulativeActual += actualValue;

    const cumulativeRow = row.nextElementSibling;
    if (cumulativeRow && cumulativeRow.classList.contains('table-light')) {
      updateCumulativeCell(cumulativeRow, 1, cumulativeTarget);
      updateCumulativeCell(cumulativeRow, 2, cumulativePlanned);
      updateCumulativeCell(cumulativeRow, 3, cumulativeActual);

      const cumulativeRateCell = cumulativeRow.querySelector('td:nth-child(4)');
      if (cumulativeRateCell) {
        let rate = 0;
        if (cumulativeTarget > 0) {
          rate = (cumulativeActual / cumulativeTarget) * 100;
        }

        const rateSpan = cumulativeRateCell.querySelector('span');
        if (rateSpan) {
          rateSpan.className = '';
          if (rate >= 100) {
            rateSpan.classList.add('text-success');
          } else if (rate >= 80) {
            rateSpan.classList.add('text-warning');
          } else {
            rateSpan.classList.add('text-danger');
          }
          rateSpan.textContent = rate.toFixed(1) + '%';
        }
      }

      const cumulativeDiffCell = cumulativeRow.querySelector('td:nth-child(5)');
      if (cumulativeDiffCell) {
        const diff = cumulativeActual - cumulativeTarget;
        const labelElement = cumulativeDiffCell.querySelector('small.text-muted');

        if (labelElement) {
          cumulativeDiffCell.innerHTML = '';
          cumulativeDiffCell.appendChild(labelElement.cloneNode(true));
          cumulativeDiffCell.appendChild(document.createTextNode(' ¥' + diff.toLocaleString('ja-JP')));

          cumulativeDiffCell.className = 'text-end';
          if (diff >= 0) {
            cumulativeDiffCell.classList.add('text-success');
          } else {
            cumulativeDiffCell.classList.add('text-danger');
          }
        }
      }
    }
  });
}

document.getElementById("bulkEditForm").addEventListener("submit", function(e) {
  // input--number-input コントローラーを持つ全ての input フィールドを処理
  document.querySelectorAll("[data-controller*='input--number-input']").forEach(function(input) {
    if (!input.disabled && input.value) {
      // カンマを削除して数値のみにする
      input.value = input.value.replace(/,/g, "");
    }
  });
});

function setEditModalData(button) {
  const date = button.getAttribute("data-date");
  const dateDisplay = button.getAttribute("data-date-display");
  const targetAmount = button.getAttribute("data-target-amount");

  const numValue = parseInt(targetAmount, 10) || 0;

  document.getElementById("editTargetDate").value = dateDisplay || "";

  const dateParts = date.split("-");
  document.getElementById("editTargetYear").value = dateParts[0] || "";
  document.getElementById("editTargetMonth").value = dateParts[1] || "";
  document.getElementById("editTargetDateValue").value = dateParts[2] || "";

  const input = document.getElementById("editTargetAmount");
  input.value = numValue.toString();

  const form = document.getElementById("editTargetForm");
  if (form) {
    form.action = "/management/numerical_managements/update_daily_target";
  }
}

function setActualModalData(button) {
  const date = button.getAttribute("data-date");
  const dateDisplay = button.getAttribute("data-date-display");
  const scheduleId = button.getAttribute("data-plan-schedule-id");
  const actualRevenue = button.getAttribute("data-actual-revenue");

  document.getElementById("actualRevenueDate").value = dateDisplay || "";

  const numValue = parseInt(actualRevenue, 10) || 0;
  const input = document.getElementById("actualRevenueInput");
  input.value = numValue.toString();
  input.dataset.rawValue = numValue.toString();

  const form = document.getElementById("actualRevenueForm");
  if (form && scheduleId) {
    form.action = "/management/plan_schedules/" + scheduleId + "/actual_revenue";

    // CSRFトークンを更新
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const tokenInput = form.querySelector('input[name="authenticity_token"]');
    if (tokenInput) {
      tokenInput.value = csrfToken;
    }
  }
}

document.addEventListener("DOMContentLoaded", function() {
  const editTargetInput = document.getElementById("editTargetAmount");
  const actualRevenueInput = document.getElementById("actualRevenueInput");
  const editMonthlyBudgetInput = document.getElementById("editMonthlyBudgetAmount");
  const newMonthlyBudgetInput = document.getElementById("newMonthlyBudgetAmount");

  initializeCumulativeValues();
});

// Turbo対応: ページ読み込み時とTurbo遷移後にイベントリスナーを再設定
document.addEventListener("turbo:load", function() {
  const toggleBtn = document.getElementById("bulkEditToggleBtn");
  const cancelBtn = document.getElementById("bulkEditCancelBtn");

  if (toggleBtn) {
    toggleBtn.removeEventListener("click", toggleBulkEditMode); // 重複防止
    toggleBtn.addEventListener("click", toggleBulkEditMode);
  }

  if (cancelBtn) {
    cancelBtn.removeEventListener("click", toggleBulkEditMode); // 重複防止
    cancelBtn.addEventListener("click", toggleBulkEditMode);
  }
});

// 一括編集フォーム送信時: カンマを削除
document.getElementById("bulkEditForm").addEventListener("submit", function(e) {
  // input--number-input コントローラーを持つ全ての input フィールドを処理
  document.querySelectorAll("[data-controller*='input--number-input']").forEach(function(input) {
    if (!input.disabled && input.value) {
      // カンマを削除して数値のみにする
      input.value = input.value.replace(/,/g, "");
    }
  });
});
</script>
