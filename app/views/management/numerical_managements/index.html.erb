<%#
  機能: 売上管理メイン画面

  主要機能:
  - 月選択フォーム
  - 予算設定・削除
  - サマリーカード・予測カード表示
  - 日別明細テーブル
  - 各種モーダル（予算設定、日別目標、実績入力、計画割当）
%>

<% content_for :title, t('numerical_managements.index.title') %>

<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0"><%= t('numerical_managements.index.title') %></h1>

    <div class="d-flex align-items-center gap-3">
      <form method="get" class="d-flex align-items-center gap-2">
        <label class="text-muted mb-0"><%= t('numerical_managements.index.target_month') %></label>

        <div class="d-flex gap-1">
          <select name="year" class="form-select form-select-sm" style="width: 90px;">
            <% (Date.current.year - 2..Date.current.year + 1).each do |year| %>
              <option value="<%= year %>" <%= 'selected' if year == @selected_date.year %>><%= year %>年</option>
            <% end %>
          </select>

          <select name="month" class="form-select form-select-sm" style="width: 80px;">
            <% (1..12).each do |month| %>
              <option value="<%= month %>" <%= 'selected' if month == @selected_date.month %>><%= month %>月</option>
            <% end %>
          </select>
        </div>

        <button type="submit" class="btn btn-primary btn-sm"><%= t('numerical_managements.index.display') %></button>
      </form>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#budgetSettingModal">
          <i class="bi bi-gear"></i> <%= t('numerical_managements.index.set_budget') %>
        </button>

        <% if @monthly_budget&.persisted? %>
          <%= button_to management_monthly_budget_path(@monthly_budget),
                        method: :delete,
                        form: { data: { turbo_confirm: t('numerical_managements.modals.confirm.delete') } },
                        class: "btn btn-outline-danger btn-sm" do %>
            <i class="bi bi-trash"></i> <%= t('numerical_managements.index.delete_budget') %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <%= render 'shared/summary_cards', forecast_data: @forecast_data, monthly_budget: @monthly_budget %>
  <%= render 'forecast_cards', forecast_data: @forecast_data %>
  <%= render 'daily_details_table', daily_data: @daily_data %>
</div>

<script>
  window.plansByCategory = <%= raw (@plans_by_category || {}).transform_values { |plans| plans.map { |p| { id: p.id, name: p.name, expected_revenue: p.expected_revenue.to_i } } }.to_json %>;
</script>

<%= render 'budget_setting_modal' %>
<%= render 'daily_target_modal' %>
<%= render 'actual_revenue_modal' %>
<%= render 'assign_plan_modal', plans_by_category: @plans_by_category %>

<script>
function setEditModalData(button) {
  const date = button.dataset.date;
  const dateDisplay = button.dataset.dateDisplay;
  const targetAmount = button.dataset.targetAmount;

  const dateObj = new Date(date);
  const year = dateObj.getFullYear();
  const month = dateObj.getMonth() + 1;
  const day = dateObj.getDate();

  document.getElementById('editTargetDate').value = dateDisplay;
  document.getElementById('editTargetDateHidden').value = date;

  const targetAmountField = document.getElementById('editTargetAmount');
  targetAmountField.value = Math.floor(parseFloat(targetAmount) || 0);
  targetAmountField.dispatchEvent(new Event('input', { bubbles: true }));

  const form = document.getElementById('editDailyTargetForm');
  form.action = `/numerical_managements/update_daily_target?year=${year}&month=${month}&day=${day}`;

  const existingMethod = form.querySelector('input[name="_method"]');
  if (existingMethod) {
    existingMethod.remove();
  }
  const methodInput = document.createElement('input');
  methodInput.type = 'hidden';
  methodInput.name = '_method';
  methodInput.value = 'patch';
  form.appendChild(methodInput);
}

function setActualModalData(button) {
  const dateDisplay = button.dataset.dateDisplay;
  const planScheduleId = button.dataset.planScheduleId;
  const actualRevenue = button.dataset.actualRevenue || 0;

  document.getElementById('editActualDate').value = dateDisplay;

  const actualRevenueField = document.getElementById('editActualRevenue');
  actualRevenueField.value = Math.floor(parseFloat(actualRevenue) || 0);
  actualRevenueField.dispatchEvent(new Event('input', { bubbles: true }));

  const form = document.getElementById('editActualRevenueForm');
  if (planScheduleId) {
    form.action = `/plan_schedules/${planScheduleId}/update_actual_revenue`;
    const existingMethod = form.querySelector('input[name="_method"]');
    if (existingMethod) {
      existingMethod.remove();
    }
    const methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'patch';
    form.appendChild(methodInput);
  }
}

function initializePlanModal() {
  const assignPlanModal = document.getElementById('assignPlanModal');
  if (!assignPlanModal) return;

  assignPlanModal.addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    if (!button) return;

    const date = button.dataset.date;
    const dateDisplay = button.dataset.dateDisplay;

    const dateField = document.getElementById('assignPlanDate');
    if (dateField) dateField.value = dateDisplay;

    const dateHiddenField = document.getElementById('assignPlanDateHidden');
    if (dateHiddenField) dateHiddenField.value = date;
  });
}

document.addEventListener('DOMContentLoaded', initializePlanModal);
document.addEventListener('turbo:load', function() {
  const assignPlanModal = document.getElementById('assignPlanModal');
  if (assignPlanModal) {
    initializePlanModal();
  }
});
</script>
