<%# カレンダーグリッド本体 %>
<%# 引数: calendar_data (週ごとの配列), budget (月間予算オブジェクト) %>

<div class="card">
  <div class="card-body">
    <table class="table table-bordered text-center">
      <thead class="table-light">
        <tr>
          <th style="width: 14.28%;"><%= t('date.abbr_day_names')[0] %></th>
          <th style="width: 14.28%;"><%= t('date.abbr_day_names')[1] %></th>
          <th style="width: 14.28%;"><%= t('date.abbr_day_names')[2] %></th>
          <th style="width: 14.28%;"><%= t('date.abbr_day_names')[3] %></th>
          <th style="width: 14.28%;"><%= t('date.abbr_day_names')[4] %></th>
          <th style="width: 14.28%;"><%= t('date.abbr_day_names')[5] %></th>
          <th style="width: 14.28%;"><%= t('date.abbr_day_names')[6] %></th>
        </tr>
      </thead>
      <tbody>
        <% calendar_data.each do |week| %>
          <tr>
            <% week.each do |day| %>
              <% if day.nil? %>
                <%# 空白セル %>
                <td class="bg-light"></td>
              <% else %>
                <%# 日付セル %>
                <td class="p-2 <%= 'table-info' if day[:is_today] %>" style="height: 120px; vertical-align: top;">
                  <div class="d-flex flex-column h-100">
                    <%# 日付と編集ボタン %>
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div class="fw-bold <%= 'text-danger' if day[:date].sunday? %> <%= 'text-primary' if day[:date].saturday? %>">
                        <%= day[:date].day %>
                      </div>
                      <% if budget %>
                        <div class="d-flex gap-1">
                          <%# 目標編集ボタン %>
                          <button type="button"
                                  class="btn btn-sm btn-outline-secondary"
                                  style="padding: 0 4px; font-size: 0.7rem;"
                                  data-bs-toggle="modal"
                                  data-bs-target="#editDailyTargetModal"
                                  data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                                  data-date-display="<%= day[:date].strftime('%-m月%-d日') %>"
                                  data-target-id="<%= day[:daily_target_id] %>"
                                  data-target-amount="<%= day[:target].to_i %>"
                                  onclick="setEditModalData(this)">
                            <i class="bi bi-pencil"></i>
                          </button>

                          <%# 計画追加ボタン %>
                          <button type="button"
                                  class="btn btn-sm btn-outline-info plan-add-btn"
                                  style="padding: 0 4px; font-size: 0.7rem;"
                                  data-bs-toggle="modal"
                                  data-bs-target="#assignPlanModal"
                                  data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                                  data-date-display="<%= day[:date].strftime('%-m月%-d日') %>">
                            <i class="bi bi-calendar-plus"></i>
                          </button>

                          <%# 実績入力ボタン（計画がある場合のみ表示） %>
                          <% if day[:plan_schedules].present? %>
                            <button type="button"
                                    class="btn btn-sm btn-outline-success"
                                    style="padding: 0 4px; font-size: 0.7rem;"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editActualRevenueModal"
                                    data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                                    data-date-display="<%= day[:date].strftime('%-m月%-d日') %>"
                                    data-plan-schedule-id="<%= day[:plan_schedule_id] %>"
                                    data-actual-revenue="<%= day[:actual] %>"
                                    onclick="setActualModalData(this)">
                              <i class="bi bi-currency-yen"></i>
                            </button>
                          <% end %>

                          <%#  印刷ボタン（計画がある場合のみ表示） %>
                          <% if day[:plan_schedules].present? %>
                            <% if day[:plan_schedules].count == 1 %>
                              <%# 計画が1つの場合：直接印刷 %>
                              <%= link_to print_plan_path(day[:plan_schedules].first.plan, date: day[:date]),
                                          class: "btn btn-sm btn-outline-primary",
                                          style: "padding: 0 4px; font-size: 0.7rem;",
                                          target: "_blank",
                                          data: { turbo: false },
                                          title: "計画を印刷" do %>
                                <i class="bi bi-printer"></i>
                              <% end %>
                            <% else %>
                              <%# 計画が複数の場合：ドロップダウン %>
                              <div class="dropdown d-inline-block">
                                <button class="btn btn-sm btn-outline-primary dropdown-toggle"
                                        type="button"
                                        style="padding: 0 4px; font-size: 0.7rem;"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                  <i class="bi bi-printer"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" style="min-width: 200px;">
                                  <% day[:plan_schedules].each do |ps| %>
                                    <li>
                                      <%= link_to print_plan_path(ps.plan, date: day[:date]),
                                                  class: "dropdown-item",
                                                  target: "_blank",
                                                  data: { turbo: false } do %>
                                        <%= ps.plan.name %>
                                      <% end %>
                                    </li>
                                  <% end %>
                                </ul>
                              </div>
                            <% end %>
                          <% end %>
                        </div>
                      <% end %>
                    </div>

                    <%# 目標 %>
                    <div class="small text-muted">
                      <%= t('numerical_managements.calendar.target_label') %>: <%= number_to_currency(day[:target], unit: "¥", precision: 0) %>
                    </div>

                    <%# 実績 %>
                    <div class="small <%= day[:actual] > 0 ? 'text-success fw-bold' : 'text-muted' %>">
                      <%= t('numerical_managements.calendar.actual_label') %>: <%= number_to_currency(day[:actual], unit: "¥", precision: 0) %>
                    </div>

                    <%# 達成率表示 %>
                    <% if day[:achievement_rate].present? %>
                      <div class="mt-1">
                        <%
                          badge_class = if day[:achievement_rate] >= 100
                                          'bg-success'
                                        elsif day[:achievement_rate] >= 80
                                          'bg-warning text-dark'
                                        else
                                          'bg-danger'
                                        end
                        %>
                        <span class="badge <%= badge_class %> small">
                          <%= t('numerical_managements.calendar.achievement_rate_label') %>: <%= day[:achievement_rate] %>%
                        </span>
                      </div>
                    <% end %>

                    <%# 計画 %>
                    <div class="small text-info">
                      <%= t('numerical_managements.calendar.plan_label') %>: <%= number_to_currency(day[:plan], unit: "¥", precision: 0) %>
                    </div>
                  </div>
                </td>
              <% end %>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>