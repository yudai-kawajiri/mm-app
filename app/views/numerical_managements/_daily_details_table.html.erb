<!-- 日別明細テーブル（一括編集対応版） -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><%= t('numerical_managements.index.daily_details') %></h5>
    <button type="button"
            class="btn btn-primary btn-sm"
            id="bulkEditToggle"
            onclick="toggleBulkEditMode()">
      <i class="bi bi-pencil-square"></i> 一括編集モード
    </button>
  </div>

  <%# 通常モード時の合計チェック（非表示） %>
  <div id="bulkEditSummary" class="card-body bg-light border-bottom" style="display: none;">
    <div class="row">
      <div class="col-md-4">
        <strong>月間予算:</strong>
        <span class="text-primary"><%= number_to_currency(@monthly_budget.target_amount || 0, unit: "¥", precision: 0) %></span>
      </div>
      <div class="col-md-4">
        <strong>日別目標合計:</strong>
        <span id="dailyTargetSum" class="fw-bold">¥0</span>
      </div>
      <div class="col-md-4">
        <strong>差分:</strong>
        <span id="budgetDiff" class="fw-bold">¥0</span>
      </div>
    </div>
  </div>

  <div class="card-body p-0">
    <%= form_with url: bulk_update_numerical_managements_path, method: :post, id: "bulkEditForm", local: true do |f| %>
      <%= hidden_field_tag :month, @selected_date.strftime('%Y-%m') %>

      <div style="max-height: 500px; overflow-y: auto;">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light sticky-top">
            <tr>
              <th style="width: 80px;">日付</th>
              <th class="text-end">目標</th>
              <th class="text-end">実績</th>
              <th class="text-end">計画</th>
              <th class="text-end">予測</th>
              <th class="text-end">差額</th>
              <th class="text-end">達成率</th>
              <th class="text-center bulk-edit-hidden" style="width: 180px;">アクション</th>
            </tr>
          </thead>
          <tbody>
            <% daily_data.each_with_index do |day, index| %>
              <%
                daily_target = @daily_targets[day[:date].day]
                target_id = daily_target&.id
              %>
              <tr>
                <%# 日付 %>
                <td style="width: 80px;"><%= day[:date].strftime('%-m/%-d') %></td>

                <%# 目標（編集可能） %>
                <td class="text-end">
                  <%# 通常表示 %>
                  <span class="normal-mode-display">
                    <%= number_to_currency((day[:target] || 0).to_i, unit: "¥", precision: 0) %>
                  </span>
                  <%# 編集モード %>
                  <div class="bulk-edit-input" style="display: none;">
                    <%= number_field_tag "daily_data[#{index}][target_amount]",
                                         day[:target].to_i,
                                         class: "form-control form-control-sm text-end bulk-edit-target",
                                         min: 0,
                                         step: 1,
                                         data: { original: day[:target].to_i } %>
                    <%= hidden_field_tag "daily_data[#{index}][date]", day[:date].strftime('%Y-%m-%d') %>
                    <%= hidden_field_tag "daily_data[#{index}][target_id]", target_id %>
                  </div>
                </td>

                <%# 実績（編集可能） %>
                <td class="text-end">
                  <%# 通常表示 %>
                  <span class="normal-mode-display">
                    <%= number_to_currency((day[:actual] || 0).to_i, unit: "¥", precision: 0) %>
                  </span>
                  <%# 編集モード %>
                  <div class="bulk-edit-input" style="display: none;">
                    <% first_schedule = day[:plan_schedules].first %>
                    <%= number_field_tag "daily_data[#{index}][actual_revenue]",
                                         (first_schedule&.actual_revenue || 0).to_i,
                                         class: "form-control form-control-sm text-end",
                                         min: 0,
                                         step: 1,
                                         disabled: day[:plan_schedules].empty? %>
                    <%= hidden_field_tag "daily_data[#{index}][plan_schedule_id]", first_schedule&.id %>
                  </div>
                </td>

                <%# 計画（読み取り専用） %>
                <td class="text-end"><%= number_to_currency((day[:planned] || 0).to_i, unit: "¥", precision: 0) %></td>

                <%# 予測 %>
                <td class="text-end"><%= number_to_currency((day[:forecast] || 0).to_i, unit: "¥", precision: 0) %></td>

                <%# 差額 %>
                <td class="text-end <%= (day[:diff] || 0) >= 0 ? 'text-success' : 'text-danger' %>">
                  <%= number_to_currency((day[:diff] || 0).to_i, unit: "¥", precision: 0) %>
                </td>

                <%# 達成率 %>
                <td class="text-end">
                  <%= number_to_percentage((day[:achievement_rate] || 0), precision: 1) %>
                </td>

                <%# アクションボタン（通常モード時のみ表示） %>
                <td class="text-center bulk-edit-hidden">
                  <div class="btn-group btn-group-sm" role="group">
                    <%# 目標編集ボタン %>
                    <button type="button"
                            class="btn btn-outline-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#editDailyTargetModal"
                            data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                            data-date-display="<%= day[:date].strftime('%-m月%-d日') %>"
                            data-target-id="<%= target_id %>"
                            data-target-amount="<%= day[:target].to_i %>"
                            onclick="setEditModalData(this)"
                            title="目標編集">
                      <i class="bi bi-pencil"></i>
                    </button>

                    <%# 計画追加ボタン %>
                    <button type="button"
                            class="btn btn-outline-info plan-add-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#assignPlanModal"
                            data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                            data-date-display="<%= day[:date].strftime('%-m月%-d日') %>"
                            data-year="<%= day[:date].year %>"
                            data-month="<%= day[:date].month %>"
                            data-day="<%= day[:date].day %>"
                            title="計画追加">
                      <i class="bi bi-calendar-plus"></i>
                    </button>

                    <%# 実績入力ボタン（計画がある場合のみ表示） %>
                    <% if day[:plan_schedules].present? %>
                      <% first_schedule = day[:plan_schedules].first %>
                      <button type="button"
                              class="btn btn-outline-success"
                              data-bs-toggle="modal"
                              data-bs-target="#editActualRevenueModal"
                              data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                              data-date-display="<%= day[:date].strftime('%-m月%-d日') %>"
                              data-plan-schedule-id="<%= first_schedule.id %>"
                              data-actual-revenue="<%= first_schedule.actual_revenue || 0 %>"
                              onclick="setActualModalData(this)"
                              title="実績入力">
                        <i class="bi bi-currency-yen"></i>
                      </button>
                    <% end %>

                    <%# 印刷ボタン（計画がある場合のみ表示） %>
                    <% if day[:plan_schedules].present? %>
                      <% if day[:plan_schedules].count == 1 %>
                        <%= link_to print_plan_path(day[:plan_schedules].first.plan, date: day[:date]),
                                    class: "btn btn-outline-primary",
                                    target: "_blank",
                                    data: { turbo: false },
                                    title: "計画を印刷" do %>
                          <i class="bi bi-printer"></i>
                        <% end %>
                      <% else %>
                        <div class="btn-group" role="group">
                          <button type="button"
                                  class="btn btn-outline-primary dropdown-toggle"
                                  data-bs-toggle="dropdown"
                                  aria-expanded="false"
                                  title="印刷する計画を選択">
                            <i class="bi bi-printer"></i>
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <% day[:plan_schedules].each do |ps| %>
                              <li>
                                <%= link_to print_plan_path(ps.plan, date: day[:date]),
                                            class: "dropdown-item",
                                            target: "_blank",
                                            data: { turbo: false } do %>
                                  <%= ps.plan.name %>
                                <% end %>
                              </li>
                            <% end %>
                          </ul>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <%# 編集モード時のボタン（非表示） %>
      <div class="card-footer bulk-edit-actions" style="display: none;">
        <div class="d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-secondary" onclick="toggleBulkEditMode()">
            <i class="bi bi-x-lg"></i> キャンセル
          </button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check-lg"></i> 一括保存
          </button>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
// グローバル変数
let isEditMode = false;
const monthlyBudget = <%= @monthly_budget.target_amount || 0 %>;

// 一括編集モードの切り替え
function toggleBulkEditMode() {
  isEditMode = !isEditMode;

  if (isEditMode) {
    // 編集モードON
    document.getElementById('bulkEditToggle').innerHTML = '<i class="bi bi-eye"></i> 通常表示';
    document.getElementById('bulkEditSummary').style.display = 'block';
    document.querySelectorAll('.normal-mode-display').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.bulk-edit-input').forEach(el => el.style.display = 'block');
    document.querySelectorAll('.bulk-edit-hidden').forEach(el => el.style.display = 'none');
    document.querySelector('.bulk-edit-actions').style.display = 'block';

    // 合計を計算
    calculateDailyTargetSum();

    // 入力イベントリスナーを追加
    document.querySelectorAll('.bulk-edit-target').forEach(input => {
      input.addEventListener('input', calculateDailyTargetSum);
    });
  } else {
    // 編集モードOFF
    document.getElementById('bulkEditToggle').innerHTML = '<i class="bi bi-pencil-square"></i> 一括編集モード';
    document.getElementById('bulkEditSummary').style.display = 'none';
    document.querySelectorAll('.normal-mode-display').forEach(el => el.style.display = 'inline');
    document.querySelectorAll('.bulk-edit-input').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.bulk-edit-hidden').forEach(el => el.style.display = 'table-cell');
    document.querySelector('.bulk-edit-actions').style.display = 'none';

    // 編集内容をリセット
    document.querySelectorAll('.bulk-edit-target').forEach(input => {
      input.value = input.dataset.original;
    });
  }
}

// 日別目標の合計を計算
function calculateDailyTargetSum() {
  let sum = 0;
  document.querySelectorAll('.bulk-edit-target').forEach(input => {
    sum += parseInt(input.value) || 0;
  });

  const diff = sum - monthlyBudget;

  // 合計を表示
  document.getElementById('dailyTargetSum').textContent = '¥' + sum.toLocaleString();

  // 差分を表示
  const diffElement = document.getElementById('budgetDiff');
  if (diff > 0) {
    diffElement.textContent = '+¥' + diff.toLocaleString() + ' 超過 ';
    diffElement.className = 'fw-bold text-danger';
  } else if (diff < 0) {
    diffElement.textContent = '-¥' + Math.abs(diff).toLocaleString() + ' 不足';
    diffElement.className = 'fw-bold text-warning';
  } else {
    diffElement.textContent = '¥0';
    diffElement.className = 'fw-bold text-success';
  }
}
</script>