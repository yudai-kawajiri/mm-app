<!-- app/views/numerical_managements/calendar.html.erb -->
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">è£½é€ è¨ˆç”»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>

    <div class="d-flex align-items-center gap-3">
      <!-- æœˆé¸æŠãƒ•ã‚©ãƒ¼ãƒ  -->
      <form method="get" class="d-flex align-items-center gap-2">
        <label class="text-muted mb-0">å¯¾è±¡æœˆ:</label>
        <input type="month" name="month" value="<%= @selected_date.strftime('%Y-%m') %>" class="form-control form-control-sm" style="width: 150px;">
        <button type="submit" class="btn btn-primary btn-sm">è¡¨ç¤º</button>
      </form>

      <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
      <%= link_to "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹", numerical_managements_path(month: @selected_date.strftime('%Y-%m')), class: "btn btn-outline-secondary btn-sm" %>
    </div>
  </div>

   <!-- æœˆé–“ã‚µãƒãƒªãƒ¼ -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">ğŸ“Š æœˆé–“ã‚µãƒãƒªãƒ¼</h5>
      <div class="row">
        <%
          monthly_target = @calendar_data.flatten.compact.sum { |day| day[:target] || 0 }
          monthly_actual = @calendar_data.flatten.compact.sum { |day| day[:actual] || 0 }
          monthly_achievement = if monthly_target > 0
                                  ((monthly_actual.to_f / monthly_target) * 100).round(1)
                                else
                                  0
                                end

          summary_badge_class = if monthly_achievement >= 100
                                  'bg-success'
                                elsif monthly_achievement >= 80
                                  'bg-warning text-dark'
                                else
                                  'bg-danger'
                                end
        %>

        <div class="col-md-3">
          <div class="text-muted small">æœˆé–“ç›®æ¨™</div>
          <div class="h5">Â¥<%= number_with_delimiter(monthly_target) %></div>
        </div>

        <div class="col-md-3">
          <div class="text-muted small">æœˆé–“å®Ÿç¸¾</div>
          <div class="h5">Â¥<%= number_with_delimiter(monthly_actual) %></div>
        </div>

        <div class="col-md-3">
          <div class="text-muted small">å·®é¡</div>
          <div class="h5 <%= monthly_actual >= monthly_target ? 'text-success' : 'text-danger' %>">
            Â¥<%= number_with_delimiter(monthly_actual - monthly_target) %>
          </div>
        </div>

        <div class="col-md-3">
          <div class="text-muted small">æœˆé–“é”æˆç‡</div>
          <div class="h5">
            <span class="badge <%= summary_badge_class %>">
              <%= monthly_achievement %>%
            </span>
          </div>
        </div>
      </div>

      <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
      <div class="progress mt-3" style="height: 25px;">
        <div class="progress-bar <%= summary_badge_class %>"
             role="progressbar"
             style="width: <%= [monthly_achievement, 100].min %>%;"
             aria-valuenow="<%= monthly_achievement %>"
             aria-valuemin="0"
             aria-valuemax="100">
          <%= monthly_achievement %>%
        </div>
      </div>
    </div>
  </div>

  <!-- äºˆç®—æœªè¨­å®šã®è­¦å‘Š -->
  <% unless @budget %>
    <div class="alert alert-warning" role="alert">
      <i class="bi bi-exclamation-triangle"></i> ã“ã®æœˆã®äºˆç®—ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
      <%= link_to "äºˆç®—ã‚’è¨­å®šã™ã‚‹", numerical_managements_path(month: @selected_date.strftime('%Y-%m')), class: "alert-link" %>
    </div>
  <% end %>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ -->
  <div class="card">
    <div class="card-body">
      <table class="table table-bordered text-center">
        <thead class="table-light">
          <tr>
            <th style="width: 14.28%;">æ—¥</th>
            <th style="width: 14.28%;">æœˆ</th>
            <th style="width: 14.28%;">ç«</th>
            <th style="width: 14.28%;">æ°´</th>
            <th style="width: 14.28%;">æœ¨</th>
            <th style="width: 14.28%;">é‡‘</th>
            <th style="width: 14.28%;">åœŸ</th>
          </tr>
        </thead>
        <tbody>
          <% @calendar_data.each do |week| %>
            <tr>
              <% week.each do |day| %>
                <% if day.nil? %>
                  <!-- ç©ºç™½ã‚»ãƒ« -->
                  <td class="bg-light"></td>
                <% else %>
                  <!-- æ—¥ä»˜ã‚»ãƒ« -->
                  <td class="p-2 <%= 'table-info' if day[:is_today] %>" style="height: 120px; vertical-align: top;">
                    <div class="d-flex flex-column h-100">
                      <!-- æ—¥ä»˜ã¨ç·¨é›†ãƒœã‚¿ãƒ³ -->
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="fw-bold <%= 'text-danger' if day[:date].sunday? %> <%= 'text-primary' if day[:date].saturday? %>">
                          <%= day[:date].day %>
                        </div>
                        <% if @budget %>
                          <div class="d-flex gap-1">
                            <!-- ç›®æ¨™ç·¨é›†ãƒœã‚¿ãƒ³ -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary"
                                    style="padding: 0 4px; font-size: 0.7rem;"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editDailyTargetModal"
                                    data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                                    data-date-display="<%= day[:date].strftime('%-mæœˆ%-dæ—¥') %>"
                                    data-target-id="<%= day[:daily_target_id] %>"
                                    data-target-amount="<%= day[:target] %>"
                                    onclick="setEditModalData(this)">
                              <i class="bi bi-pencil"></i>
                            </button>

                            <!-- è¨ˆç”»è¿½åŠ ãƒœã‚¿ãƒ³ -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-info"
                                    style="padding: 0 4px; font-size: 0.7rem;"
                                    data-bs-toggle="modal"
                                    data-bs-target="#assignPlanModal"
                                    data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                                    data-date-display="<%= day[:date].strftime('%-mæœˆ%-dæ—¥') %>"
                                    onclick="setDateForPlanModal(this, event)">
                              <i class="bi bi-calendar-plus"></i>
                            </button>


                            <!-- å®Ÿç¸¾å…¥åŠ›ãƒœã‚¿ãƒ³ -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-success"
                                    style="padding: 0 4px; font-size: 0.7rem;"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editActualRevenueModal"
                                    data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                                    data-date-display="<%= day[:date].strftime('%-mæœˆ%-dæ—¥') %>"
                                    data-plan-schedule-id="<%= day[:plan_schedule_id] %>"
                                    data-actual-revenue="<%= day[:actual] %>"
                                    onclick="setActualModalData(this)">
                              <i class="bi bi-currency-yen"></i>
                            </button>
                          </div>
                        <% end %>
                      </div>

                      <!-- ç›®æ¨™ -->
                      <div class="small text-muted">
                        ç›®æ¨™: <%= number_to_currency(day[:target], unit: "Â¥", precision: 0) %>
                      </div>

                      <!-- å®Ÿç¸¾ -->
                      <div class="small <%= day[:actual] > 0 ? 'text-success fw-bold' : 'text-muted' %>">
                        å®Ÿç¸¾: <%= number_to_currency(day[:actual], unit: "Â¥", precision: 0) %>
                      </div>

                      <!-- é”æˆç‡è¡¨ç¤º -->
                      <% if day[:achievement_rate].present? %>
                        <div class="mt-1">
                          <%
                            # é”æˆç‡ã«å¿œã˜ãŸè‰²åˆ†ã‘
                            badge_class = if day[:achievement_rate] >= 100
                                            'bg-success'
                                          elsif day[:achievement_rate] >= 80
                                            'bg-warning text-dark'
                                          else
                                            'bg-danger'
                                          end
                          %>
                          <span class="badge <%= badge_class %> small">
                            é”æˆç‡: <%= day[:achievement_rate] %>%
                          </span>
                        </div>
                      <% end %>

                      <!-- è¨ˆç”» -->
                      <div class="small text-info">
                        è¨ˆç”»: <%= number_to_currency(day[:plan], unit: "Â¥", precision: 0) %>
                      </div>
                    </div>
                  </td>
                <% end %>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- å‡¡ä¾‹ -->
  <div class="mt-3">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">å‡¡ä¾‹</h6>
        <div class="d-flex gap-4">
          <div><span class="badge bg-info">â– </span> ä»Šæ—¥</div>
          <div><span class="text-danger">â—</span> æ—¥æ›œæ—¥</div>
          <div><span class="text-primary">â—</span> åœŸæ›œæ—¥</div>
          <div><span class="text-success fw-bold">å®Ÿç¸¾</span> å®Ÿç¸¾å…¥åŠ›æ¸ˆã¿</div>
          <div><span class="text-info">è¨ˆç”»</span> è£½é€ è¨ˆç”»ã‚ã‚Š</div>
          <div><i class="bi bi-pencil"></i> ç›®æ¨™ç·¨é›†</div>
          <div><i class="bi bi-calendar-plus text-info"></i> è¨ˆç”»è¿½åŠ </div>
          <div><i class="bi bi-currency-yen text-success"></i> å®Ÿç¸¾å…¥åŠ›</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- æ—¥åˆ¥ç›®æ¨™ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="editDailyTargetModal" tabindex="-1" aria-labelledby="editDailyTargetModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDailyTargetModalLabel">æ—¥åˆ¥ç›®æ¨™ç·¨é›†</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <%= form_with model: DailyTarget.new, url: "#", method: :patch, local: true, id: "editDailyTargetForm" do |f| %>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">å¯¾è±¡æ—¥</label>
            <input type="text" class="form-control" id="editTargetDate" readonly>
          </div>

          <div class="mb-3">
            <%= f.label :target_amount, "æ—¥åˆ¥ç›®æ¨™ï¼ˆå††ï¼‰", class: "form-label" %>
            <%= f.number_field :target_amount, class: "form-control", min: 0, step: 1, required: true, placeholder: "ä¾‹: 51613", id: "editTargetAmount" %>
          </div>

          <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> ã“ã®æ—¥ã®ç›®æ¨™é‡‘é¡ã‚’å¤‰æ›´ã—ã¾ã™ã€‚æœˆé–“äºˆç®—ã®åˆè¨ˆã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <%= f.submit "æ›´æ–°", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- å®Ÿç¸¾å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="editActualRevenueModal" tabindex="-1" aria-labelledby="editActualRevenueModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editActualRevenueModalLabel">å®Ÿç¸¾å…¥åŠ›</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <%= form_with model: PlanSchedule.new, url: "#", method: :post, local: true, id: "editActualRevenueForm" do |f| %>
        <%= hidden_field_tag :month, @selected_date.strftime('%Y-%m') %>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">å¯¾è±¡æ—¥</label>
            <input type="text" class="form-control" id="editActualDate" readonly>
          </div>

          <div class="mb-3">
            <%= f.label :actual_revenue, "å®Ÿç¸¾å£²ä¸Šï¼ˆå††ï¼‰", class: "form-label" %>
            <%= f.number_field :actual_revenue, class: "form-control", min: 0, step: 1, required: true, placeholder: "ä¾‹: 45000", id: "editActualRevenue" %>
          </div>

          <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> ã“ã®æ—¥ã®å®Ÿç¸¾å£²ä¸Šã‚’å…¥åŠ›ã—ã¾ã™ã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <%= f.submit "ä¿å­˜", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- è¨ˆç”»è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="assignPlanModal" tabindex="-1" aria-labelledby="assignPlanModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with model: PlanSchedule.new, url: plan_schedules_path, method: :post, local: true, data: { controller: "plan-assignment" } do |f| %>
        <div class="modal-header">
          <h5 class="modal-title" id="assignPlanModalLabel">è¨ˆç”»ã‚’è¿½åŠ </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆéè¡¨ç¤ºï¼‰ -->
          <%= f.hidden_field :scheduled_date, id: "plan_scheduled_date" %>

          <!-- è¨ˆç”»é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
          <div class="mb-3">
            <%= f.label :plan_id, "è¨ˆç”»ã‚’é¸æŠ", class: "form-label" %>
            <%= f.collection_select :plan_id,
                  Plan.all,
                  :id,
                  :name_with_total,
                  { prompt: "è¨ˆç”»ã‚’é¸æŠã—ã¦ãã ã•ã„" },
                  {
                    class: "form-select",
                    required: true,
                    data: {
                      plan_assignment_target: "planSelect",
                      action: "change->plan-assignment#updateRevenue"
                    }
                  }
            %>
          </div>

          <!-- è¨ˆç”»é«˜ï¼ˆè‡ªå‹•å…¥åŠ›ã€èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ -->
          <div class="mb-3">
            <%= f.label :planned_revenue, "è¨ˆç”»é«˜ï¼ˆå††ï¼‰", class: "form-label" %>
            <%= f.number_field :planned_revenue,
                  class: "form-control bg-light",
                  readonly: true,
                  data: { plan_assignment_target: "revenueField" }
            %>
            <div class="form-text">è¨ˆç”»ã‚’é¸æŠã™ã‚‹ã¨è‡ªå‹•çš„ã«å…¥åŠ›ã•ã‚Œã¾ã™</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <%= f.submit "ä¿å­˜", class: "btn btn-primary", data: { disable_with: "ä¿å­˜ä¸­..." } %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
// è¨ˆç”»è¿½åŠ ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«æ—¥ä»˜ã‚’è¨­å®š
function setDateForPlanModal(button, event) {
  console.log("=== setDateForPlanModal called ===");

  const date = button.getAttribute('data-date');
  console.log("Date from button:", date);

  // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®š
  setTimeout(function() {
    const modal = document.getElementById('assignPlanModal');
    const dateHiddenInput = modal.querySelector('#plan_scheduled_date');

    if (dateHiddenInput) {
      dateHiddenInput.value = date;
      console.log("Date field set to:", dateHiddenInput.value);
    } else {
      console.error("Date hidden field not found!");
    }

    // è¨ˆç”»é¸æŠã¨revenueã‚’ã‚¯ãƒªã‚¢
    const planSelect = modal.querySelector('select[name="plan_schedule[plan_id]"]');
    if (planSelect) {
      planSelect.value = '';
    }

    const revenueField = modal.querySelector('input[name="plan_schedule[planned_revenue]"]');
    if (revenueField) {
      revenueField.value = '';
    }
  }, 100);
}

// DOMContentLoaded: ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
document.addEventListener('DOMContentLoaded', function() {
  console.log("=== Calendar JavaScript Loaded ===");

  const assignPlanModal = document.getElementById('assignPlanModal');
  if (assignPlanModal) {
    const form = assignPlanModal.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const dateField = form.querySelector('#plan_scheduled_date');
        const planSelect = form.querySelector('select[name="plan_schedule[plan_id]"]');
        const revenueField = form.querySelector('input[name="plan_schedule[planned_revenue]"]');

        console.log("=== Form Submit Validation ===");
        console.log("Date:", dateField?.value);
        console.log("Plan ID:", planSelect?.value);
        console.log("Revenue:", revenueField?.value);

        if (!dateField?.value) {
          e.preventDefault();
          alert('æ—¥ä»˜ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
          return false;
        }

        if (!planSelect?.value) {
          e.preventDefault();
          alert('è¨ˆç”»ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return false;
        }

        if (!revenueField?.value) {
          e.preventDefault();
          alert('è¨ˆç”»ã‚’é¸æŠã—ã¦å£²ä¸Šã‚’è¨­å®šã—ã¦ãã ã•ã„');
          return false;
        }

        console.log("=== Form validation passed, submitting... ===");
      });
    }
  }
});

// æ—¥åˆ¥ç›®æ¨™ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¨­å®š
function setEditModalData(button) {
  const date = button.getAttribute('data-date');
  const dateDisplay = button.getAttribute('data-date-display');
  const targetId = button.getAttribute('data-target-id');
  const targetAmount = button.getAttribute('data-target-amount');

  const modal = document.getElementById('editDailyTargetModal');
  const form = modal.querySelector('form');
  const dateSpan = modal.querySelector('#editTargetDate');
  const amountInput = modal.querySelector('#editTargetAmount');

  if (targetId && targetId !== '') {
    form.action = `/daily_targets/${targetId}`;
  } else {
    form.action = '#';
  }

  dateSpan.value = dateDisplay;
  amountInput.value = targetAmount || '';

  let dateHiddenInput = form.querySelector('input[name="daily_target[target_date]"]');
  if (!dateHiddenInput) {
    dateHiddenInput = document.createElement('input');
    dateHiddenInput.type = 'hidden';
    dateHiddenInput.name = 'daily_target[target_date]';
    form.appendChild(dateHiddenInput);
  }
  dateHiddenInput.value = date;
}

// å®Ÿç¸¾å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¨­å®š
function setActualModalData(button) {
  const date = button.getAttribute('data-date');
  const dateDisplay = button.getAttribute('data-date-display');
  const planScheduleId = button.getAttribute('data-plan-schedule-id');
  const actualRevenue = button.getAttribute('data-actual-revenue');

  const modal = document.getElementById('editActualRevenueModal');
  const form = modal.querySelector('form');
  const dateSpan = modal.querySelector('#editActualDate');
  const revenueInput = modal.querySelector('#editActualRevenue');
  const submitButton = form.querySelector('input[type="submit"]');

  if (planScheduleId && planScheduleId !== '') {
    form.action = `/plan_schedules/${planScheduleId}`;
    let methodInput = form.querySelector('input[name="_method"]');
    if (methodInput) {
      methodInput.value = 'patch';
    }
    if (submitButton) submitButton.value = 'æ›´æ–°';
  } else {
    form.action = '/plan_schedules';
    let methodInput = form.querySelector('input[name="_method"]');
    if (methodInput) {
      methodInput.value = 'post';
    }
    if (submitButton) submitButton.value = 'ä¿å­˜';
  }

  dateSpan.value = dateDisplay;
  revenueInput.value = actualRevenue || '';

  let dateHiddenInput = form.querySelector('input[name="plan_schedule[scheduled_date]"]');
  if (!dateHiddenInput) {
    dateHiddenInput = document.createElement('input');
    dateHiddenInput.type = 'hidden';
    dateHiddenInput.name = 'plan_schedule[scheduled_date]';
    form.appendChild(dateHiddenInput);
  }
  dateHiddenInput.value = date;
}
</script>
