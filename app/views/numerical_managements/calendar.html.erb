<!-- app/views/numerical_managements/calendar.html.erb -->
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">製造計画カレンダー</h1>

    <div class="d-flex align-items-center gap-3">
      <!-- 月選択フォーム -->
      <form method="get" class="d-flex align-items-center gap-2">
        <label class="text-muted mb-0">対象月:</label>
        <input type="month" name="month" value="<%= @selected_date.strftime('%Y-%m') %>" class="form-control form-control-sm" style="width: 150px;">
        <button type="submit" class="btn btn-primary btn-sm">表示</button>
      </form>

      <!-- ダッシュボードに戻るボタン -->
      <%= link_to "ダッシュボードに戻る", numerical_managements_path(month: @selected_date.strftime('%Y-%m')), class: "btn btn-outline-secondary btn-sm" %>
    </div>
  </div>

  <!-- 予算未設定の警告 -->
  <% unless @budget %>
    <div class="alert alert-warning" role="alert">
      <i class="bi bi-exclamation-triangle"></i> この月の予算が設定されていません。
      <%= link_to "予算を設定する", numerical_managements_path(month: @selected_date.strftime('%Y-%m')), class: "alert-link" %>
    </div>
  <% end %>

  <!-- カレンダーグリッド -->
  <div class="card">
    <div class="card-body">
      <table class="table table-bordered text-center">
        <thead class="table-light">
          <tr>
            <th style="width: 14.28%;">日</th>
            <th style="width: 14.28%;">月</th>
            <th style="width: 14.28%;">火</th>
            <th style="width: 14.28%;">水</th>
            <th style="width: 14.28%;">木</th>
            <th style="width: 14.28%;">金</th>
            <th style="width: 14.28%;">土</th>
          </tr>
        </thead>
        <tbody>
          <% @calendar_data.each do |week| %>
            <tr>
              <% week.each do |day| %>
                <% if day.nil? %>
                  <!-- 空白セル -->
                  <td class="bg-light"></td>
                <% else %>
                  <!-- 日付セル -->
                  <td class="p-2 <%= 'table-info' if day[:is_today] %>" style="height: 120px; vertical-align: top;">
                    <div class="d-flex flex-column h-100">
                      <!-- 日付と編集ボタン -->
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="fw-bold <%= 'text-danger' if day[:date].sunday? %> <%= 'text-primary' if day[:date].saturday? %>">
                          <%= day[:date].day %>
                        </div>
                        <% if @budget %>
                          <div class="d-flex gap-1">
                            <!-- 目標編集ボタン -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary"
                                    style="padding: 0 4px; font-size: 0.7rem;"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editDailyTargetModal"
                                    data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                                    data-date-display="<%= day[:date].strftime('%-m月%-d日') %>"
                                    data-target-id="<%= day[:daily_target_id] %>"
                                    data-target-amount="<%= day[:target] %>"
                                    onclick="setEditModalData(this)">
                              <i class="bi bi-pencil"></i>
                            </button>

                            <!-- 計画追加ボタン -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-info"
                                    style="padding: 0 4px; font-size: 0.7rem;"
                                    data-bs-toggle="modal"
                                    data-bs-target="#assignPlanModal"
                                    data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                                    data-date-display="<%= day[:date].strftime('%-m月%-d日') %>"
                                    onclick="setDateForPlanModal(this, event)">
                              <i class="bi bi-calendar-plus"></i>
                            </button>


                            <!-- 実績入力ボタン -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-success"
                                    style="padding: 0 4px; font-size: 0.7rem;"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editActualRevenueModal"
                                    data-date="<%= day[:date].strftime('%Y-%m-%d') %>"
                                    data-date-display="<%= day[:date].strftime('%-m月%-d日') %>"
                                    data-plan-schedule-id="<%= day[:plan_schedule_id] %>"
                                    data-actual-revenue="<%= day[:actual] %>"
                                    onclick="setActualModalData(this)">
                              <i class="bi bi-currency-yen"></i>
                            </button>
                          </div>
                        <% end %>
                      </div>

                      <!-- 目標 -->
                      <div class="small text-muted">
                        目標: <%= number_to_currency(day[:target], unit: "¥", precision: 0) %>
                      </div>

                      <!-- 実績 -->
                      <div class="small <%= day[:actual] > 0 ? 'text-success fw-bold' : 'text-muted' %>">
                        実績: <%= number_to_currency(day[:actual], unit: "¥", precision: 0) %>
                      </div>

                      <!-- 達成率表示 -->
                      <% if day_data[:achievement_rate].present? %>
                        <div class="mt-1">
                          <%
                            # 達成率に応じた色分け
                            badge_class = if day_data[:achievement_rate] >= 100
                                            'bg-success'
                                          elsif day_data[:achievement_rate] >= 80
                                            'bg-warning text-dark'
                                          else
                                            'bg-danger'
                                          end
                          %>
                          <span class="badge <%= badge_class %> small">
                            達成率: <%= day_data[:achievement_rate] %>%
                          </span>
                        </div>
                      <% end %>


                      <!-- 計画 -->
                      <div class="small text-info">
                        計画: <%= number_to_currency(day[:plan], unit: "¥", precision: 0) %>
                      </div>
                    </div>
                  </td>
                <% end %>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 凡例 -->
  <div class="mt-3">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">凡例</h6>
        <div class="d-flex gap-4">
          <div><span class="badge bg-info">■</span> 今日</div>
          <div><span class="text-danger">●</span> 日曜日</div>
          <div><span class="text-primary">●</span> 土曜日</div>
          <div><span class="text-success fw-bold">実績</span> 実績入力済み</div>
          <div><span class="text-info">計画</span> 製造計画あり</div>
          <div><i class="bi bi-pencil"></i> 目標編集</div>
          <div><i class="bi bi-calendar-plus text-info"></i> 計画追加</div>
          <div><i class="bi bi-currency-yen text-success"></i> 実績入力</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 日別目標編集モーダル -->
<div class="modal fade" id="editDailyTargetModal" tabindex="-1" aria-labelledby="editDailyTargetModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDailyTargetModalLabel">日別目標編集</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <%= form_with model: DailyTarget.new, url: "#", method: :patch, local: true, id: "editDailyTargetForm" do |f| %>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">対象日</label>
            <input type="text" class="form-control" id="editTargetDate" readonly>
          </div>

          <div class="mb-3">
            <%= f.label :target_amount, "日別目標（円）", class: "form-label" %>
            <%= f.number_field :target_amount, class: "form-control", min: 0, step: 1, required: true, placeholder: "例: 51613", id: "editTargetAmount" %>
          </div>

          <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> この日の目標金額を変更します。月間予算の合計には影響しません。
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <%= f.submit "更新", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- 実績入力モーダル -->
<div class="modal fade" id="editActualRevenueModal" tabindex="-1" aria-labelledby="editActualRevenueModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editActualRevenueModalLabel">実績入力</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <%= form_with model: PlanSchedule.new, url: "#", method: :post, local: true, id: "editActualRevenueForm" do |f| %>
        <%= hidden_field_tag :month, @selected_date.strftime('%Y-%m') %>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">対象日</label>
            <input type="text" class="form-control" id="editActualDate" readonly>
          </div>

          <div class="mb-3">
            <%= f.label :actual_revenue, "実績売上（円）", class: "form-label" %>
            <%= f.number_field :actual_revenue, class: "form-control", min: 0, step: 1, required: true, placeholder: "例: 45000", id: "editActualRevenue" %>
          </div>

          <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> この日の実績売上を入力します。カレンダーに反映されます。
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <%= f.submit "保存", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- 計画追加モーダル -->
<div class="modal fade" id="assignPlanModal" tabindex="-1" aria-labelledby="assignPlanModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with model: PlanSchedule.new, url: plan_schedules_path, method: :post, local: true, data: { controller: "plan-assignment" } do |f| %>
        <div class="modal-header">
          <h5 class="modal-title" id="assignPlanModalLabel">計画を追加</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- 日付フィールド（非表示） -->
          <%= f.hidden_field :scheduled_date, id: "plan_scheduled_date" %>

          <!-- 計画選択ドロップダウン -->
          <div class="mb-3">
            <%= f.label :plan_id, "計画を選択", class: "form-label" %>
            <%= f.collection_select :plan_id,
                  Plan.all,
                  :id,
                  :name_with_total,
                  { prompt: "計画を選択してください" },
                  {
                    class: "form-select",
                    required: true,
                    data: {
                      plan_assignment_target: "planSelect",
                      action: "change->plan-assignment#updateRevenue"
                    }
                  }
            %>
          </div>

          <!-- 計画高（自動入力、読み取り専用） -->
          <div class="mb-3">
            <%= f.label :planned_revenue, "計画高（円）", class: "form-label" %>
            <%= f.number_field :planned_revenue,
                  class: "form-control bg-light",
                  readonly: true,
                  data: { plan_assignment_target: "revenueField" }
            %>
            <div class="form-text">計画を選択すると自動的に入力されます</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <%= f.submit "保存", class: "btn btn-primary", data: { disable_with: "保存中..." } %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
// 計画追加ボタンクリック時に日付を設定
function setDateForPlanModal(button, event) {
  console.log("=== setDateForPlanModal called ===");

  const date = button.getAttribute('data-date');
  console.log("Date from button:", date);

  // 少し待ってからモーダルのフィールドを設定
  setTimeout(function() {
    const modal = document.getElementById('assignPlanModal');
    const dateHiddenInput = modal.querySelector('#plan_scheduled_date');

    if (dateHiddenInput) {
      dateHiddenInput.value = date;
      console.log("Date field set to:", dateHiddenInput.value);
    } else {
      console.error("Date hidden field not found!");
    }

    // 計画選択とrevenueをクリア
    const planSelect = modal.querySelector('select[name="plan_schedule[plan_id]"]');
    if (planSelect) {
      planSelect.value = '';
    }

    const revenueField = modal.querySelector('input[name="plan_schedule[planned_revenue]"]');
    if (revenueField) {
      revenueField.value = '';
    }
  }, 100);
}

// DOMContentLoaded: フォームバリデーション
document.addEventListener('DOMContentLoaded', function() {
  console.log("=== Calendar JavaScript Loaded ===");

  const assignPlanModal = document.getElementById('assignPlanModal');
  if (assignPlanModal) {
    const form = assignPlanModal.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const dateField = form.querySelector('#plan_scheduled_date');
        const planSelect = form.querySelector('select[name="plan_schedule[plan_id]"]');
        const revenueField = form.querySelector('input[name="plan_schedule[planned_revenue]"]');

        console.log("=== Form Submit Validation ===");
        console.log("Date:", dateField?.value);
        console.log("Plan ID:", planSelect?.value);
        console.log("Revenue:", revenueField?.value);

        if (!dateField?.value) {
          e.preventDefault();
          alert('日付が設定されていません。ページをリロードして再度お試しください。');
          return false;
        }

        if (!planSelect?.value) {
          e.preventDefault();
          alert('計画を選択してください');
          return false;
        }

        if (!revenueField?.value) {
          e.preventDefault();
          alert('計画を選択して売上を設定してください');
          return false;
        }

        console.log("=== Form validation passed, submitting... ===");
      });
    }
  }
});

// 日別目標編集モーダルの設定
function setEditModalData(button) {
  const date = button.getAttribute('data-date');
  const dateDisplay = button.getAttribute('data-date-display');
  const targetId = button.getAttribute('data-target-id');
  const targetAmount = button.getAttribute('data-target-amount');

  const modal = document.getElementById('editDailyTargetModal');
  const form = modal.querySelector('form');
  const dateSpan = modal.querySelector('#editTargetDate');
  const amountInput = modal.querySelector('#editTargetAmount');

  if (targetId && targetId !== '') {
    form.action = `/daily_targets/${targetId}`;
  } else {
    form.action = '#';
  }

  dateSpan.value = dateDisplay;
  amountInput.value = targetAmount || '';

  let dateHiddenInput = form.querySelector('input[name="daily_target[target_date]"]');
  if (!dateHiddenInput) {
    dateHiddenInput = document.createElement('input');
    dateHiddenInput.type = 'hidden';
    dateHiddenInput.name = 'daily_target[target_date]';
    form.appendChild(dateHiddenInput);
  }
  dateHiddenInput.value = date;
}

// 実績入力モーダルの設定
function setActualModalData(button) {
  const date = button.getAttribute('data-date');
  const dateDisplay = button.getAttribute('data-date-display');
  const planScheduleId = button.getAttribute('data-plan-schedule-id');
  const actualRevenue = button.getAttribute('data-actual-revenue');

  const modal = document.getElementById('editActualRevenueModal');
  const form = modal.querySelector('form');
  const dateSpan = modal.querySelector('#editActualDate');
  const revenueInput = modal.querySelector('#editActualRevenue');
  const submitButton = form.querySelector('input[type="submit"]');

  if (planScheduleId && planScheduleId !== '') {
    form.action = `/plan_schedules/${planScheduleId}`;
    let methodInput = form.querySelector('input[name="_method"]');
    if (methodInput) {
      methodInput.value = 'patch';
    }
    if (submitButton) submitButton.value = '更新';
  } else {
    form.action = '/plan_schedules';
    let methodInput = form.querySelector('input[name="_method"]');
    if (methodInput) {
      methodInput.value = 'post';
    }
    if (submitButton) submitButton.value = '保存';
  }

  dateSpan.value = dateDisplay;
  revenueInput.value = actualRevenue || '';

  let dateHiddenInput = form.querySelector('input[name="plan_schedule[scheduled_date]"]');
  if (!dateHiddenInput) {
    dateHiddenInput = document.createElement('input');
    dateHiddenInput.type = 'hidden';
    dateHiddenInput.name = 'plan_schedule[scheduled_date]';
    form.appendChild(dateHiddenInput);
  }
  dateHiddenInput.value = date;
}
</script>
