<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-graph-up me-2"></i>数値管理</h2>

    <!-- カレンダービューへの切り替えボタン -->
    <div>
      <%= link_to calendar_numerical_managements_path(year: @year, month: @month), class: "btn btn-outline-primary me-2" do %>
        <i class="bi bi-calendar3"></i> カレンダー表示
      <% end %>
      <%= link_to authenticated_root_path, class: "btn btn-outline-secondary" do %>
        <i class="bi bi-house"></i> ダッシュボードに戻る
      <% end %>
    </div>
  </div>

  <%# 年月選択 %>
  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: numerical_managements_path, method: :get, class: "row g-3 align-items-end" do |f| %>
        <div class="col-auto">
          <label class="form-label">年</label>
          <%= f.select :year,
              (Date.current.year - 2..Date.current.year + 1).to_a,
              { selected: @year },
              class: "form-select" %>
        </div>
        <div class="col-auto">
          <label class="form-label">月</label>
          <%= f.select :month,
              (1..12).to_a,
              { selected: @month },
              class: "form-select" %>
        </div>
        <div class="col-auto">
          <%= f.submit "表示", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>

  <%# 予算設定 %>
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><%= @year %>年<%= @month %>月の予算</h5>
    </div>
    <div class="card-body">
      <%= form_with model: @monthly_budget,
          url: update_budget_numerical_managements_path,
          method: :post,
          local: true,
          class: "row g-3" do |f| %>
        <%= f.hidden_field :budget_month, value: @current_date %>

        <div class="col-md-6">
          <label class="form-label">目標金額</label>
          <div class="input-group">
            <span class="input-group-text">¥</span>
            <%= f.number_field :target_amount,
                class: "form-control",
                min: 0,
                step: 1000,
                placeholder: "例: 1520000" %>
          </div>
        </div>

        <div class="col-md-6 d-flex align-items-end">
          <%= f.submit @monthly_budget.persisted? ? "予算を更新" : "予算を設定", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>

  <%# 統計カード %>
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-bg-primary">
        <div class="card-body">
          <h6 class="card-title">目標予算</h6>
          <h3 class="mb-0">
            <%= @budget ? number_to_currency(@budget.target_amount, unit: "¥", precision: 0) : "未設定" %>
          </h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-bg-info">
        <div class="card-body">
          <h6 class="card-title">計画売上</h6>
          <h3 class="mb-0">
            <%= number_to_currency(@plan_schedules.sum { |ps| ps.expected_revenue }, unit: "¥", precision: 0) %>
          </h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-bg-success">
        <div class="card-body">
          <h6 class="card-title">実績売上</h6>
          <h3 class="mb-0">
            <%= number_to_currency(@plan_schedules.sum { |ps| ps.actual_revenue || 0 }, unit: "¥", precision: 0) %>
          </h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card <%= @budget && @budget.achievement_rate >= 100 ? 'text-bg-success' : 'text-bg-warning' %>">
        <div class="card-body">
          <h6 class="card-title">達成率</h6>
          <h3 class="mb-0">
            <%= @budget ? "#{@budget.achievement_rate.round(1)}%" : "N/A" %>
          </h3>
        </div>
      </div>
    </div>
  </div>

  <%# 日別テーブル %>
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">日別明細</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>日付</th>
              <th>計画名</th>
              <th>カテゴリ</th>
              <th class="text-end">予定売上</th>
              <th class="text-end">実績売上</th>
              <th class="text-end">差異</th>
              <th>ステータス</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <% @daily_summary.each do |day| %>
              <% if day[:schedules].any? %>
                <% day[:schedules].each_with_index do |schedule, index| %>
                  <tr>
                    <% if index == 0 %>
                      <td rowspan="<%= day[:schedules].count %>">
                        <%= l(day[:date], format: :short) %>
                        <br>
                        <small class="text-muted"><%= %w[日 月 火 水 木 金 土][day[:date].wday] %></small>
                      </td>
                    <% end %>
                    <td><%= schedule.plan.name %></td>
                    <td><%= schedule.plan.category&.name %></td>
                    <td class="text-end"><%= number_to_currency(schedule.expected_revenue, unit: "¥", precision: 0) %></td>
                    <td class="text-end"><%= number_to_currency(schedule.actual_revenue || 0, unit: "¥", precision: 0) %></td>
                    <td class="text-end <%= schedule.variance >= 0 ? 'text-success' : 'text-danger' %>">
                      <%= number_to_currency(schedule.variance, unit: "¥", precision: 0) %>
                    </td>
                    <td>
                      <% if schedule.actual_revenue.present? %>
                        <span class="badge bg-success">完了</span>
                      <% else %>
                        <span class="badge bg-secondary">未実施</span>
                      <% end %>
                    </td>
                    <td>
                      <button type="button" class="btn btn-sm btn-outline-primary"
                              data-bs-toggle="modal"
                              data-bs-target="#actualModal<%= schedule.id %>">
                        実績入力
                      </button>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<%# 実績入力モーダル（各スケジュールごとに生成） %>
<% @daily_summary.each do |day| %>
  <% day[:schedules].each do |schedule| %>
    <div class="modal fade" id="actualModal<%= schedule.id %>" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <%= form_with model: schedule,
              url: update_actual_numerical_management_path(schedule),
              method: :patch,
              local: true do |f| %>
            <div class="modal-header">
              <h5 class="modal-title">実績入力</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <strong>計画名:</strong> <%= schedule.plan.name %>
              </div>
              <div class="mb-3">
                <strong>予定売上:</strong> <%= number_to_currency(schedule.expected_revenue, unit: "¥", precision: 0) %>
              </div>
              <div class="mb-3">
                <%= f.label :actual_revenue, "実績売上", class: "form-label" %>
                <%= f.number_field :actual_revenue, class: "form-control", min: 0, step: 1000 %>
              </div>
              <div class="mb-3">
                <%= f.label :note, "メモ", class: "form-label" %>
                <%= f.text_area :note, class: "form-control", rows: 3 %>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
              <%= f.submit "保存", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
<% end %>