<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-graph-up me-2"></i>数値管理</h2>
    <%= link_to "ダッシュボードに戻る", authenticated_root_path, class: "btn btn-outline-secondary" %>
  </div>

  <%# 年月選択 %>
  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: numerical_managements_path, method: :get, class: "row g-3 align-items-end" do |f| %>
        <div class="col-auto">
          <label class="form-label">年</label>
          <%= f.select :year,
              (Date.current.year - 2..Date.current.year + 1).to_a,
              { selected: @year },
              class: "form-select" %>
        </div>
        <div class="col-auto">
          <label class="form-label">月</label>
          <%= f.select :month,
              (1..12).to_a,
              { selected: @month },
              class: "form-select" %>
        </div>
        <div class="col-auto">
          <%= f.submit "表示", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>

  <%# 予算設定 %>
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><%= @year %>年<%= @month %>月の予算</h5>
    </div>
    <div class="card-body">
      <%= form_with model: @monthly_budget,
          url: update_budget_numerical_managements_path,
          method: :patch,
          class: "row g-3" do |f| %>
        <%= f.hidden_field :year, value: @year %>
        <%= f.hidden_field :month, value: @month %>

        <div class="col-md-6">
          <label class="form-label">目標金額</label>
          <div class="input-group">
            <span class="input-group-text">¥</span>
            <%= f.number_field :target_amount,
                class: "form-control",
                min: 0,
                step: 1000,
                placeholder: "例: 1520000" %>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">備考</label>
          <%= f.text_field :note, class: "form-control", placeholder: "備考（任意）" %>
        </div>

        <div class="col-12">
          <%= f.submit "予算を保存", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>

  <%# 統計情報 %>
  <% if @monthly_budget.persisted? %>
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h6 class="text-muted mb-2">目標金額</h6>
            <h3 class="mb-0">¥<%= number_with_delimiter(@monthly_budget.target_amount.to_i) %></h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h6 class="text-muted mb-2">計画高</h6>
            <h3 class="mb-0">¥<%= number_with_delimiter(@stats[:total_planned].to_i) %></h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h6 class="text-muted mb-2">累計実績</h6>
            <h3 class="mb-0">¥<%= number_with_delimiter(@stats[:total_actual].to_i) %></h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center <%= @stats[:achievement_rate] >= 100 ? 'bg-success text-white' : '' %>">
          <div class="card-body">
            <h6 class="<%= @stats[:achievement_rate] >= 100 ? 'text-white' : 'text-muted' %> mb-2">予測達成率</h6>
            <h3 class="mb-0"><%= @stats[:achievement_rate] %>%</h3>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <%# 日別一覧 %>
  <div class="card">
    <div class="card-header bg-light">
      <h5 class="mb-0">日別計画・実績</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>日付</th>
              <th>計画名</th>
              <th class="text-end">予定売上</th>
              <th class="text-end">実績売上</th>
              <th class="text-end">差異</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <% @daily_summary.each do |day| %>
              <% if day[:has_schedules] %>
                <% day[:schedules].each_with_index do |schedule, index| %>
                  <tr class="<%= 'table-success' if schedule.has_actual? %>">
                    <% if index == 0 %>
                      <td rowspan="<%= day[:schedules].count %>" class="align-middle">
                        <%= day[:date].strftime('%m/%d') %>
                        <small class="d-block text-muted"><%= %w[日 月 火 水 木 金 土][day[:date].wday] %></small>
                      </td>
                    <% end %>
                    <td><%= schedule.plan.name %></td>
                    <td class="text-end">¥<%= number_with_delimiter(schedule.expected_revenue.to_i) %></td>
                    <td class="text-end">
                      <% if schedule.has_actual? %>
                        ¥<%= number_with_delimiter(schedule.actual_revenue.to_i) %>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                    <td class="text-end">
                      <% if schedule.has_actual? %>
                        <% variance = schedule.revenue_variance %>
                        <span class="<%= variance >= 0 ? 'text-success' : 'text-danger' %>">
                          <%= variance >= 0 ? '+' : '' %>¥<%= number_with_delimiter(variance.to_i) %>
                        </span>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                    <td>
                      <% if day[:is_past] || day[:is_today] %>
                        <%= link_to "実績入力", "#",
                            class: "btn btn-sm btn-outline-primary",
                            data: {
                              bs_toggle: "modal",
                              bs_target: "#actualModal#{schedule.id}"
                            } %>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>

      <% if @daily_summary.none? { |day| day[:has_schedules] } %>
        <div class="alert alert-info text-center">
          この月にはまだ計画がスケジュールされていません。<br>
          <%= link_to "製造計画を作成", plans_path, class: "btn btn-primary mt-2" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%# 実績入力モーダル %>
<% @plan_schedules.each do |schedule| %>
  <div class="modal fade" id="actualModal<%= schedule.id %>" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <%= form_with model: schedule,
            url: update_actual_numerical_management_path(schedule),
            method: :patch do |f| %>
          <div class="modal-header">
            <h5 class="modal-title">実績入力：<%= schedule.plan.name %></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">日付</label>
              <p class="form-control-plaintext"><%= schedule.scheduled_date.strftime('%Y年%m月%d日') %></p>
            </div>
            <div class="mb-3">
              <label class="form-label">予定売上</label>
              <p class="form-control-plaintext">¥<%= number_with_delimiter(schedule.expected_revenue.to_i) %></p>
            </div>
            <div class="mb-3">
              <label class="form-label">実績売上 <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text">¥</span>
                <%= f.number_field :actual_revenue,
                    class: "form-control",
                    min: 0,
                    value: schedule.actual_revenue,
                    required: true %>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">備考</label>
              <%= f.text_area :note, class: "form-control", rows: 3 %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
            <%= f.submit "保存", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>