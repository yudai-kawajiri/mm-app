<%#
  機能: 製造計画商品詳細タブ（読み取り専用）
  - 詳細画面での商品一覧をタブ表示
  - 全商品タブ + カテゴリ別タブ
  - カテゴリ合計・総合計を表示

  必須引数:
  - all_plan_products: Array<PlanProduct> - 全商品配列
  - product_categories: Array<Category> - 商品カテゴリ配列
%>
<% all_plan_products = @plan_products %>
<% product_categories = @product_categories || [] %>

<% total_amount = all_plan_products.sum { |pp| pp.production_count * pp.product&.price } %>
<div class="text-end mb-3">
  <span class="text-muted"><%= t('plans.total_price_label') %>:</span>
  <span class="h4 text-dark"><%= number_to_currency(total_amount, precision: 0) %></span>
</div>

<nav>
  <div class="nav nav-tabs" id="planProductTab" role="tablist">
    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#plan-product-all" type="button" role="tab" aria-controls="plan-product-all" aria-selected="true">
      <%= t('plans.tab_all') %>
    </button>

    <% used_category_ids = all_plan_products.map { |pp| pp.product&.category_id }.compact.uniq %>
    <% product_categories.select { |c| used_category_ids.include?(c.id) }.each do |category| %>
      <button class="nav-link" id="<%= category.id %>-tab" data-bs-toggle="tab" data-bs-target="#plan-product-<%= category.id %>" type="button" role="tab" aria-controls="plan-product-<%= category.id %>" aria-selected="false">
        <%= category.name %>
      </button>
    <% end %>
  </div>
</nav>

<div class="tab-content pt-3" id="planProductTabContent">
  <div class="tab-pane fade show active" id="plan-product-all" role="tabpanel" aria-labelledby="all-tab">
    <%= render 'plans/product_table', plan_products: all_plan_products %>
  </div>

  <% used_category_ids = all_plan_products.map { |pp| pp.product&.category_id }.compact.uniq %>
  <% product_categories.select { |c| used_category_ids.include?(c.id) }.each do |category| %>
    <% filtered_plan_products = all_plan_products.select { |pp| pp.product&.category_id == category.id } %>
    <div class="tab-pane fade" id="plan-product-<%= category.id %>" role="tabpanel" aria-labelledby="<%= category.id %>-tab">
      <%= render 'plans/product_table', plan_products: filtered_plan_products %>

      <div class="text-end mt-3 border-top pt-2">
        <span class="text-muted"><%= t('plans.category_total_label') %>:</span>
        <% category_tab_total = filtered_plan_products.sum { |pp| pp.production_count * pp.product&.price } %>
        <span class="h5 text-dark"><%= number_to_currency(category_tab_total, precision: 0) %></span>
      </div>
    </div>
  <% end %>
</div>
