<%
  # ユニークなrow_idを生成（既存レコードはid、新規はtimestamp）
  row_unique_id = f.object.persisted? ? "row_#{f.object.id}" : "row_#{Time.now.to_i}_#{rand(1000)}"
%>

<tr data-controller="resources--plan-product--row resources--plan-product--sync form--nested-form-item"
    data-plan-product-price-value="<%= f.object.product&.price.to_f || 0.0 %>"
    data-plan-product-category-id-value="<%= f.object.product&.category_id || local_assigns[:category_id] || 0 %>"
    data-row-unique-id="<%= row_unique_id %>"
    data-category-id="<%= local_assigns[:category_id] || f.object.product&.category_id || 0 %>">

  <%= f.hidden_field :_destroy,
      value: f.object.marked_for_destruction? ? 1 : 0,
      data: { 'form--nested-form-item-target': 'destroy' } %><%= f.hidden_field :id %>

  <td style="width: 35%;">
    <% current_category_id = f.object.product&.category_id || local_assigns[:category_id] %>
    <% products = current_category_id ? Product.where(category_id: current_category_id) : Product.all %>
    <%= f.collection_select(:product_id, products, :id, :name,
        { include_blank: '選択してください' },
        { class: 'form-select form-select-sm',
          data: {
            # 修正: actionとtarget名を更新
            action: 'change->resources--plan-product--row#updateProduct change->resources--plan-product--sync#syncProductToOtherTabs',
            'resources--plan-product--row-target': 'productSelect',
            'row-unique-id': row_unique_id
          }
        }) %>
  </td>

  <td style="width: 15%;">
    <%= f.number_field :production_count,
        class: 'form-control form-control-sm',
        min: 0,
        placeholder: '数量',
        data: {
          # 修正: actionとtarget名を更新
          'resources--plan-product--row-target': 'productionCount',
          action: 'input->resources--plan-product--row#calculate input->resources--plan-product--sync#syncQuantityToOtherTabs',
          'row-unique-id': row_unique_id
        } %>
  </td>

  <td style="width: 20%;" class="text-end">
    <span data-resources--plan-product--row-target="priceDisplay" class="d-inline-block pt-1">
      <%= number_to_currency(f.object.product&.price.to_f || 0, unit: '¥', precision: 0) %>
    </span>
  </td>

  <td style="width: 20%;" class="text-end fw-bold">
    <span data-resources--plan-product--row-target="subtotal">
      <%= number_to_currency((f.object.subtotal_calculated_for_view rescue 0), unit: '¥', precision: 0) %>
    </span>
  </td>

  <td style="width: 10%;" class="text-end">
    <button type="button"
        class="btn btn-danger btn-sm"
        data-action="click->form--nested-form-item#remove"
        data-row-unique-id="<%= row_unique_id %>">
      削除
    </button>
  </td>
</tr>