<%= form_with(model: @plan, local: true) do |f| %>

  <div data-controller="plan-product nested-form category-tab-manager"
       data-plan-product-target="totalContainer"
       data-action="plan-product:calculated->plan-product#recalculate">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex justify-content-start align-items-center">
        <%= select_tag("category_selector",
            options_from_collection_for_select(@product_categories, :id, :name),
            {
              prompt: 'カテゴリを選択',
              class: 'form-select me-2',
              style: 'width: 250px;',
              data: {
                'category-tab-manager-target': 'categorySelector',
                'action': 'change->category-tab-manager#toggleButton'
              }
            }) %>

        <button type="button"
                class="btn btn-primary"
                data-action="category-tab-manager#showSelectedTab"
                data-category-tab-manager-target="showButton"
                disabled>
          カテゴリタブを追加
        </button>
      </div>

      <span class="fw-bold fs-5">
        総合計:
        <span data-plan-product-target="grandTotal" class="text-primary">
          ¥0
        </span>
      </span>
    </div>

    <!-- タブナビゲーション -->
  <div class="nav nav-tabs" role="tablist" data-category-tab-manager-target="tabNav">
    <!-- ALLタブ（削除不可） -->
    <button class="nav-link active"
            id="nav-0-tab"
            data-bs-toggle="tab"
            data-bs-target="#nav-0"
            type="button"
            role="tab"
            aria-controls="nav-0"
            aria-selected="true"
            data-category-id="0">
      全て
    </button>

    <!-- 既存カテゴリタブ（×ボタン付き） -->
    <% displayed_category_ids = @plan.plan_products.map { |pp| pp.product&.category_id }.compact.uniq %>
    <% @product_categories.select { |c| displayed_category_ids.include?(c.id) }.each do |category| %>
      <button class="nav-link position-relative"
              id="nav-<%= category.id %>-tab"
              data-bs-toggle="tab"
              data-bs-target="#nav-<%= category.id %>"
              type="button"
              role="tab"
              aria-controls="nav-<%= category.id %>"
              aria-selected="false"
              data-category-id="<%= category.id %>"
              style="padding-right: 2.5rem;">
        <%= category.name %>
        <span class="position-absolute top-50 end-0 translate-middle-y pe-2"
              style="cursor: pointer; font-weight: bold; color: #dc3545;"
              data-action="click->category-tab-manager#removeTab"
              data-category-id="<%= category.id %>">
          ×
        </span>
      </button>
    <% end %>
  </div>

  <!-- タブコンテンツ -->
  <div class="tab-content pt-3" data-category-tab-manager-target="contentContainer">
    <!-- ALLタブコンテンツ -->
    <div class="tab-pane fade show active"
         id="nav-0"
         role="tabpanel"
         aria-labelledby="nav-0-tab"
         data-category-id="0">
      <%= render 'shared/category_tab_content',
          category_id: 0,
          category_name: 'すべて',
          plan: @plan,
          product_categories: @product_categories,
          f: f %>
    </div>

    <!-- 既存カテゴリタブコンテンツ -->
    <% @product_categories.select { |c| displayed_category_ids.include?(c.id) }.each do |category| %>
      <div class="tab-pane fade"
           id="nav-<%= category.id %>"
           role="tabpanel"
           aria-labelledby="nav-<%= category.id %>-tab"
           data-category-id="<%= category.id %>">
        <%= render 'shared/category_tab_content',
            category_id: category.id,
            category_name: category.name,
            plan: @plan,
            product_categories: @product_categories,
            f: f %>
      </div>
    <% end %>
  </div>

  <!-- テンプレート: タブボタン -->
  <template data-category-tab-manager-target="categoryTemplate">
    <button class="nav-link position-relative"
            id="nav-CATEGORY_ID_PLACEHOLDER-tab"
            data-bs-toggle="tab"
            data-bs-target="#nav-CATEGORY_ID_PLACEHOLDER"
            type="button"
            role="tab"
            aria-controls="nav-CATEGORY_ID_PLACEHOLDER"
            aria-selected="false"
            data-category-id="CATEGORY_ID_PLACEHOLDER"
            style="padding-right: 2.5rem;">
      CATEGORY_NAME_PLACEHOLDER
      <span class="position-absolute top-50 end-0 translate-middle-y pe-2"
            style="cursor: pointer; font-weight: bold; color: #dc3545;"
            data-action="click->category-tab-manager#removeTab"
            data-category-id="CATEGORY_ID_PLACEHOLDER">
        ×
      </span>
    </button>
  </template>

  <!-- テンプレート: タブコンテンツ -->
  <template data-category-tab-manager-target="categoryPaneTemplate">
    <div class="tab-pane fade"
         id="nav-CATEGORY_ID_PLACEHOLDER"
         role="tabpanel"
         aria-labelledby="nav-CATEGORY_ID_PLACEHOLDER-tab"
         data-category-id="CATEGORY_ID_PLACEHOLDER">

      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th style="width: 35%;">商品名</th>
              <th style="width: 15%;">数量</th>
              <th style="width: 20%;" class="text-end">売価</th>
              <th style="width: 20%;" class="text-end">小計</th>
              <th style="width: 10%;" class="text-end">アクション</th>
            </tr>
          </thead>
          <tbody data-nested-form-target="target" data-category-id="CATEGORY_ID_PLACEHOLDER">
            <!-- 商品行がここに追加される -->
          </tbody>
        </table>

        <div class="mt-3">
          <button type="button"
                  class="btn btn-outline-success w-100"
                  data-category-id="CATEGORY_ID_PLACEHOLDER"
                  data-template-id="plan_product_fields_template_CATEGORY_ID_PLACEHOLDER"
                  data-action="click->nested-form#add">
            商品を追加
          </button>
        </div>

        <!-- カテゴリ合計 -->
        <div class="text-end mt-3 fw-bold">
          カテゴリ合計:
          <span data-plan-product-target="categoryTotal" data-category-id="CATEGORY_ID_PLACEHOLDER">¥0</span>
        </div>
      </div>
    </div>
  </template>

  <!-- 商品行テンプレート（各カテゴリ用） -->
  <% @product_categories.each do |category| %>
    <template id="plan_product_fields_template_<%= category.id %>" data-nested-form-target="template">
      <%= f.fields_for :plan_products,
          @plan.plan_products.build(product: Product.new(category_id: category.id)),
          child_index: 'NEW_RECORD' do |product_f| %>
        <%= render 'plan_product_fields', f: product_f, category_id: category.id %>
      <% end %>
    </template>
  <% end %>

</div>
<% end %>