<div data-controller="plan-products nested-form plan-product-tabs"
    data-plan-products-target="totalContainer"
    data-plan-product-tabs-category-id-value="<%= @plan.category_id %>"
    data-action="plan-product:calculated->plan-products#recalculate">

 <%# --------------------- ç·åˆè¨ˆè¡¨ç¤º (ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢ã«æˆ»ã™) - %>
    <div class="d-flex justify-content-end mb-3">
        <span class="fw-bold me-2">ç·åˆè¨ˆ:</span>
        <span class="fw-bold text-end text-danger" data-plan-products-target="totalPrice">
            <%= number_to_currency(@plan.total_price_calculated_for_view, unit: 'Â¥') rescue number_to_currency(0, unit: 'Â¥') %>
        </span>
    </div>

  <%# --------------------- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ (ul) --------------------- %>
  <nav>
    <div class="nav nav-tabs" id="nav-tab" role="tablist">
      <% @tabs_categories.each_with_index do |category, index| %>
        <button class="nav-link <%= index == 0 ? 'active' : '' %>"
                id="nav-<%= category.id %>-tab"
                data-bs-toggle="tab"
                data-bs-target="#nav-<%= category.id %>"
                type="button"
                role="tab"
                aria-controls="nav-<%= category.id %>"
                aria-selected="<%= index == 0 ? 'true' : 'false' %>"
                data-category-name="<%= category.name %>">
          <%= category.name %>
        </button>
      <% end %>
    </div>
  </nav>

  <%# --------------------- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (div.tab-content) --------------------- %>
  <div class="tab-content pt-3" id="nav-tabContent">
    <% @tabs_categories.each_with_index do |category, index| %>
      <div class="tab-pane fade <%= index == 0 ? 'show active' : '' %>"
           id="nav-<%= category.id %>"
           role="tabpanel"
           aria-labelledby="nav-<%= category.id %>-tab"
           data-plan-product-tabs-target="category"
           data-category-id="<%= category.id %>">

        <%# --------------------- ã‚«ãƒ†ã‚´ãƒªãƒ¼å†…ã®ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå•†å“ãƒªã‚¹ãƒˆæœ¬ä½“ï¼‰ --------------------- %>
        <%# âœ… ä¿®æ­£: data-category-id ã‚’è¿½åŠ ã—ã¦ã€JSå´ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ç‰¹å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ %>
        <div data-nested-form-target="target" data-category-id="<%= category.id %>">

          <%# ğŸ’¡ æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æç”» (ç·¨é›†ç”»é¢å¯¾å¿œ) %>
          <% @plan.product_plans.select { |pp| pp.product.present? && pp.product.category_id == category.id }.each do |plan_product| %>
            <%= f.fields_for :product_plans, plan_product, child_index: plan_product.object_id do |plan_product_f| %>
              <%= render 'plan_product_fields', f: plan_product_f %>
            <% end %>
          <% end %>

          <%# --------------------- åˆæœŸãƒ¬ã‚³ãƒ¼ãƒ‰ã®ãƒ“ãƒ«ãƒ‰ --------------------- %>
          <% if @plan.new_record? && index == 0 %>
            <%= f.fields_for :product_plans, f.object.product_plans.build(product: Product.new(category_id: category.id)), child_index: "initial_record" do |plan_product_f| %>
              <%= render 'plan_product_fields', f: plan_product_f %>
            <% end %>
          <% end %>
        </div>


         <%# â­ è¿½åŠ : ã‚«ãƒ†ã‚´ãƒªåˆè¨ˆã®è¡¨ç¤ºã‚¨ãƒªã‚¢ (å„ã‚¿ãƒ–ã®æœ€ä¸‹éƒ¨) %>
        <div class="d-flex justify-content-end mt-3 fw-bold">
            <span class="me-2"><%= category.name %> åˆè¨ˆ:</span>
            <span data-plan-products-target="categoryTotal"
                  data-category-id="<%= category.id %>"
                  class="text-end text-success">
                <%= number_to_currency(0, unit: 'Â¥') %>
            </span>
        </div>

        <%# --------------------- å•†å“è¿½åŠ ãƒœã‚¿ãƒ³ --------------------- %>
        <div class="d-grid mt-3 mb-4">
          <button type="button" class="btn btn-sm btn-outline-success"
                  data-action="nested-form#add"
                  data-association="product_plans"
                  data-category-id="<%= category.id %>"
                  data-template-id="plan_product_fields_template_<%= category.id %>">
            + <%= category.name %> ã‚’è¿½åŠ 
          </button>
        </div>

      </div>
    <% end %>
  </div>

  <%# --------------------- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆè¤‡è£½å…ƒï¼‰ --------------------- %>
  <% @tabs_categories.each do |category| %>
    <%= f.fields_for :product_plans, f.object.product_plans.build(product: Product.new(category_id: category.id)), child_index: 'NEW_RECORD' do |plan_product_f| %>
      <template data-nested-form-target="template"
                id="plan_product_fields_template_<%= category.id %>">
        <%= render 'plan_product_fields', f: plan_product_f %>
      </template>
    <% end %>
  <% end %>

</div>