<% all_plan_products = @plan_products %>
<% product_categories = @product_categories || [] %>

<%# 総合計の表示を追加 %>
<% total_amount = all_plan_products.sum { |pp| pp.production_count * pp.product&.price } %>
<div class="text-end mb-3">
  <span class="text-muted"><%= t('plans.grand_total', default: '総合計') %>:</span>
  <span class="h4 text-dark"><%= number_to_currency(total_amount, precision: 0) %></span>
</div>

<%# タブナビゲーション %>
<nav>
  <div class="nav nav-tabs" id="planProductTab" role="tablist">
    <%# Allタブ %>
    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#plan-product-all" type="button" role="tab" aria-controls="plan-product-all" aria-selected="true">
      <%= t('plans.tab_all', default: '全て') %>
    </button>

    <%# カテゴリ別のタブ（計画に使用されているカテゴリのみ表示） %>
    <% used_category_ids = all_plan_products.map { |pp| pp.product&.category_id }.compact.uniq %>
    <% product_categories.select { |c| used_category_ids.include?(c.id) }.each do |category| %>
      <button class="nav-link" id="<%= category.id %>-tab" data-bs-toggle="tab" data-bs-target="#plan-product-<%= category.id %>" type="button" role="tab" aria-controls="plan-product-<%= category.id %>" aria-selected="false">
        <%= category.name %>
      </button>
    <% end %>
  </div>
</nav>

<div class="tab-content pt-3" id="planProductTabContent">

    <%# 1. すべて (All) タブの内容 %>
    <div class="tab-pane fade show active" id="plan-product-all" role="tabpanel" aria-labelledby="all-tab">
      <%= render 'plans/product_table', plan_products: all_plan_products %>
   </div>

    <%# 2. カテゴリ別のタブの内容（計画に使用されているカテゴリのみ） %>
    <% used_category_ids = all_plan_products.map { |pp| pp.product&.category_id }.compact.uniq %>
    <% product_categories.select { |c| used_category_ids.include?(c.id) }.each do |category| %>
      <% filtered_plan_products = all_plan_products.select { |pp| pp.product&.category_id == category.id } %>
      <div class="tab-pane fade" id="plan-product-<%= category.id %>" role="tabpanel" aria-labelledby="<%= category.id %>-tab">
        <%= render 'plans/product_table', plan_products: filtered_plan_products %>

        <%# カテゴリタブ内の合計金額表示 %>
        <div class="text-end mt-3 border-top pt-2">
          <span class="text-muted"><%= t('plans.tab_total', default: 'カテゴリ合計') %>:</span>
          <% category_tab_total = filtered_plan_products.sum { |pp| pp.production_count * pp.product&.price } %>
          <span class="h5 text-dark"><%= number_to_currency(category_tab_total, precision: 0) %></span>
        </div>
      </div>
    <% end %>
</div>