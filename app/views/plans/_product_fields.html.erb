<%#
  機能: 製造計画商品行パーシャル
  - 1つの商品行を表示（テーブル行形式）
  - 商品選択、数量入力、価格・小計表示、削除ボタン
  - Stimulus Controllerで動的計算・同期処理
  - フォーム新規作成・編集画面で使用

  必須引数:
  - f: FormBuilder - plan_productsのフォームビルダー

  オプション引数:
  - category_id: Integer - カテゴリID（商品フィルタリング用）
%>
<% row_unique_id = f.object.persisted? ? "row_#{f.object.id}" : "row_#{Time.now.to_i}_#{rand(1000)}"%>

<tr data-controller="resources--plan-product--row resources--plan-product--sync form--nested-form-item"
    data-plan-product-price-value="<%= f.object.product&.price.to_f || 0.0 %>"
    data-plan-product-category-id-value="<%= f.object.product&.category_id || local_assigns[:category_id] || 0 %>"
    data-row-unique-id="<%= row_unique_id %>"
    data-category-id="<%= local_assigns[:category_id] || f.object.product&.category_id || 0 %>">

  <%= f.hidden_field :_destroy,
      value: f.object.marked_for_destruction? ? 1 : 0,
      data: { 'form--nested-form-item-target': 'destroy' } %>
  <%= f.hidden_field :id %>

  <td style="width: 35%;">
    <% current_category_id = f.object.product&.category_id || local_assigns[:category_id] %>
    <% products = current_category_id ? Product.where(category_id: current_category_id) : Product.all %>
    <%= f.collection_select(:product_id, products, :id, :name,
        { include_blank: t('helpers.select.prompt') },
        { class: 'form-select form-select-sm',
          data: {
            action: 'change->resources--plan-product--row#updateProduct change->resources--plan-product--sync#syncProductToOtherTabs',
            'resources--plan-product--row-target': 'productSelect',
            'row-unique-id': row_unique_id
          }
        }) %>
  </td>

  <td style="width: 15%;">
    <%= f.number_field :production_count,
        class: 'form-control form-control-sm',
        min: 0,
        placeholder: t('activerecord.attributes.plan_product.production_count'),
        data: {
          controller: 'number-input',
          'resources--plan-product--row-target': 'productionCount',
          action: 'input->number-input#handleInput input->resources--plan-product--row#calculate input->resources--plan-product--sync#syncQuantityToOtherTabs paste->number-input#handlePaste',
          'row-unique-id': row_unique_id
        } %>
  </td>

  <td style="width: 20%;" class="text-end">
    <span data-resources--plan-product--row-target="priceDisplay" class="d-inline-block pt-1">
      <%= number_to_currency(f.object.product&.price.to_f || 0, unit: '¥', precision: 0) %>
    </span>
  </td>

  <td style="width: 20%;" class="text-end fw-bold">
    <span data-resources--plan-product--row-target="subtotal">
      <%= number_to_currency((f.object.subtotal_calculated_for_view rescue 0), unit: '¥', precision: 0) %>
    </span>
  </td>

  <td style="width: 10%;" class="text-end">
    <button type="button"
      class="btn btn-danger btn-sm"
      data-action="click->form--nested-form-item#remove"
      data-row-unique-id="<%= row_unique_id %>"
      title="<%= t('helpers.link.destroy') %>">
      <i class="bi bi-trash"></i>
    </button>
  </td>
</tr>
