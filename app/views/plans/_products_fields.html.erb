<%#
  機能: 製造計画商品フォームフィールド（複雑版）
  - カテゴリタブによる商品管理
  - 動的なタブ追加・削除機能
  - カテゴリ別合計・総合計の自動計算
  - Stimulus Controllerによる高度なインタラクション
  - 新規作成・編集画面の右カラムで使用

  必須引数:
  - f: FormBuilder - planのフォームビルダー
%>
<div class="card mb-3">
  <div class="card-header bg-light">
    <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i><%= t('forms.titles.plan_product') %></h5>
  </div>
  <div class="card-body">
    <div data-controller="resources--plan-product--totals tabs--category-tabs form--nested-form"
        data-resources--plan-product--totals-target="totalContainer"
        data-action="resources--plan-product--row:calculated->resources--plan-product--totals#recalculate">

      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex justify-content-start align-items-center">
          <%= select_tag("category_selector",
              options_from_collection_for_select(@product_categories, :id, :name),
              {
                prompt: t('plans.category_selector.prompt'),
                class: 'form-select me-2',
                style: 'width: 250px;',
                data: {
                  'tabs--category-tabs-target': 'categorySelector',
                  'action': 'change->tabs--category-tabs#toggleButton'
                }
              }) %>

          <button type="button"
                  class="btn btn-primary"
                  data-action="click->tabs--category-tabs#showSelectedTab"
                  data-tabs--category-tabs-target="showButton"
                  disabled>
            <%= t('plans.category_selector.add_button') %>
          </button>
        </div>

        <span class="fw-bold fs-5">
          <%= t('plans.total_price_label') %>:
          <span data-resources--plan-product--totals-target="grandTotal" class="text-primary">¥0</span>
        </span>
      </div>

      <div class="nav nav-tabs" role="tablist" data-tabs--category-tabs-target="tabNav">
        <button class="nav-link active"
                id="nav-0-tab"
                data-bs-toggle="tab"
                data-bs-target="#nav-0"
                type="button"
                role="tab"
                aria-controls="nav-0"
                aria-selected="true"
                data-category-id="0">
          <%= t('plans.tab_all') %>
        </button>

        <% displayed_category_ids = @plan.plan_products.map { |pp| pp.product&.category_id }.compact.uniq %>
        <% @product_categories.select { |c| displayed_category_ids.include?(c.id) }.each do |category| %>
          <button class="nav-link position-relative"
                  id="nav-<%= category.id %>-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-<%= category.id %>"
                  type="button"
                  role="tab"
                  aria-controls="nav-<%= category.id %>"
                  aria-selected="false"
                  data-category-id="<%= category.id %>"
                  style="padding-right: 2.5rem;">
            <%= category.name %>
            <span class="position-absolute top-50 end-0 translate-middle-y pe-2"
                  style="cursor: pointer; font-weight: bold; color: #dc3545;"
                  data-action="click->tabs--category-tabs#removeTab"
                  data-category-id="<%= category.id %>">
              ×
            </span>
          </button>
        <% end %>
      </div>

      <div class="tab-content pt-3" data-tabs--category-tabs-target="contentContainer">
        <div class="tab-pane fade show active"
             id="nav-0"
             role="tabpanel"
             aria-labelledby="nav-0-tab"
             data-category-id="0">
          <%= render 'shared/components/tabs/category_tab_content',
              category_id: 0,
              items: @plan.plan_products.reject(&:marked_for_destruction?),
              form_builder: f,
              association_name: :plan_products,
              item_partial: 'product_fields',
              table_headers: %{
                <tr>
                  <th style="width: 35%;">#{t('plans.table_headers.product_name')}</th>
                  <th style="width: 15%;">#{t('plans.table_headers.quantity')}</th>
                  <th style="width: 20%;" class="text-end">#{t('plans.table_headers.price')}</th>
                  <th style="width: 20%;" class="text-end">#{t('plans.table_headers.subtotal')}</th>
                  <th style="width: 10%;" class="text-end">#{t('common.action')}</th>
                </tr>
              },
              add_button_text: t('plans.add_product_button'),
              show_category_total: true %>
        </div>

        <% @product_categories.select { |c| displayed_category_ids.include?(c.id) }.each do |category| %>
          <div class="tab-pane fade"
               id="nav-<%= category.id %>"
               role="tabpanel"
               aria-labelledby="nav-<%= category.id %>-tab"
               data-category-id="<%= category.id %>">
            <%= render 'shared/components/tabs/category_tab_content',
                category_id: category.id,
                items: @plan.plan_products.select { |pp| pp.product&.category_id == category.id && !pp.marked_for_destruction? },
                form_builder: f,
                association_name: :plan_products,
                item_partial: 'product_fields',
                table_headers: %{
                  <tr>
                    <th style="width: 35%;">#{t('plans.table_headers.product_name')}</th>
                    <th style="width: 15%;">#{t('plans.table_headers.quantity')}</th>
                    <th style="width: 20%;" class="text-end">#{t('plans.table_headers.price')}</th>
                    <th style="width: 20%;" class="text-end">#{t('plans.table_headers.subtotal')}</th>
                    <th style="width: 10%;" class="text-end">#{t('common.action')}</th>
                  </tr>
                },
                add_button_text: t('plans.add_product_button'),
                show_category_total: true,
                total_target: 'plan-product-target' %>
          </div>
        <% end %>
      </div>

      <template data-tabs--category-tabs-target="categoryTemplate">
        <button class="nav-link position-relative"
                id="nav-CATEGORY_ID_PLACEHOLDER-tab"
                data-bs-toggle="tab"
                data-bs-target="#nav-CATEGORY_ID_PLACEHOLDER"
                type="button"
                role="tab"
                aria-controls="nav-CATEGORY_ID_PLACEHOLDER"
                aria-selected="false"
                data-category-id="CATEGORY_ID_PLACEHOLDER"
                style="padding-right: 2.5rem;">
          CATEGORY_NAME_PLACEHOLDER
          <span class="position-absolute top-50 end-0 translate-middle-y pe-2"
                style="cursor: pointer; font-weight: bold; color: #dc3545;"
                data-action="click->tabs--category-tabs#removeTab"
                data-category-id="CATEGORY_ID_PLACEHOLDER">
            ×
          </span>
        </button>
      </template>

      <template data-tabs--category-tabs-target="categoryPaneTemplate">
        <div class="tab-pane fade"
             id="nav-CATEGORY_ID_PLACEHOLDER"
             role="tabpanel"
             aria-labelledby="nav-CATEGORY_ID_PLACEHOLDER-tab"
             data-category-id="CATEGORY_ID_PLACEHOLDER">

          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th style="width: 35%;"><%= t('plans.table_headers.product_name') %></th>
                  <th style="width: 15%;"><%= t('plans.table_headers.quantity') %></th>
                  <th style="width: 20%;" class="text-end"><%= t('plans.table_headers.price') %></th>
                  <th style="width: 20%;" class="text-end"><%= t('plans.table_headers.subtotal') %></th>
                  <th style="width: 10%;" class="text-end"><%= t('common.action') %></th>
                </tr>
              </thead>
              <tbody data-form--nested-form-target="target" data-category-id="CATEGORY_ID_PLACEHOLDER">
              </tbody>
            </table>

            <div class="mt-3">
              <button type="button"
                      class="btn btn-outline-success w-100"
                      data-category-id="CATEGORY_ID_PLACEHOLDER"
                      data-template-id="product_fields_template_CATEGORY_ID_PLACEHOLDER"
                      data-action="click->form--nested-form#add">
                <%= t('plans.add_product_button') %>
              </button>
            </div>

            <div class="text-end mt-3 fw-bold">
              <%= t('plans.category_total_label') %>:
              <span data-resources--plan-product--totals-target="categoryTotal" data-category-id="CATEGORY_ID_PLACEHOLDER">¥0</span>
            </div>
          </div>
        </div>
      </template>

      <% @product_categories.each do |category| %>
        <template id="product_fields_template_<%= category.id %>" data-form--nested-form-target="template">
          <%= f.fields_for :plan_products,
              @plan.plan_products.build(product: Product.new(category_id: category.id)),
              child_index: 'NEW_RECORD' do |product_f| %>
            <%= render 'product_fields', f: product_f, category_id: category.id %>
          <% end %>
        </template>
      <% end %>

    </div>
  </div>
</div>
