<% content_for :title, @plan&.name || '計画' %>

<div style="padding: 20px; font-family: sans-serif;">
  <!-- ===== 1ページ目: 製造計画書（商品一覧） ===== -->
  <div style="border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px;">
    <h2 style="margin: 0;">① 製造計画書（商品一覧）</h2>
    <div style="font-size: 11pt; color: #333; margin-top: 5px;">
      <strong>計画名:</strong> <%= @plan.name %> |
      <strong>実施日:</strong> <%= @scheduled_date&.strftime('%Y年%m月%d日') || '未設定' %> |
      <strong>予算:</strong> ¥<%= number_with_delimiter(@budget) %> |
      <strong>計画高:</strong> ¥<%= number_with_delimiter(@total_cost) %> |
      <strong>達成率:</strong> <%= @achievement_rate %>%
    </div>
  </div>

  <!-- 商品テーブル -->
  <table style="width: 100%; border-collapse: collapse; font-size: 10pt;">
    <thead>
      <tr style="background-color: #f0f0f0;">
        <th style="border: 1px solid #666; padding: 8px;">画像</th>
        <th style="border: 1px solid #666; padding: 8px;">品番</th>
        <th style="border: 1px solid #666; padding: 8px;">商品名</th>
        <th style="border: 1px solid #666; padding: 8px;">製造数</th>
        <th style="border: 1px solid #666; padding: 8px;">単価</th>
        <th style="border: 1px solid #666; padding: 8px;">小計</th>
      </tr>
    </thead>
    <tbody>
      <% if @plan_products.present? %>
        <% @plan_products.each do |plan_product| %>
          <% product = plan_product.product %>
          <tr>
            <!-- 画像 -->
            <td style="border: 1px solid #999; padding: 8px; text-align: center;">
              <% if product.image.attached? %>
                <%= image_tag product.image, style: 'width: 45px; height: 45px; object-fit: cover; border-radius: 4px;' %>
              <% else %>
                <div style="width: 45px; height: 45px; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 8pt; color: #666;">
                  画像なし
                </div>
              <% end %>
            </td>

            <!-- 品番 -->
            <td style="border: 1px solid #999; padding: 8px;"><%= product.item_number %></td>

            <!-- 商品名 -->
            <td style="border: 1px solid #999; padding: 8px;"><%= product.name %></td>

            <!-- 製造数 -->
            <td style="border: 1px solid #999; padding: 8px; text-align: right;">
              <%= number_with_delimiter(plan_product.production_count) %> 個
            </td>

            <!-- 単価 -->
            <td style="border: 1px solid #999; padding: 8px; text-align: right;">
              ¥<%= number_with_delimiter(product.price) %>
            </td>

            <!-- 小計 -->
            <td style="border: 1px solid #999; padding: 8px; text-align: right;">
              ¥<%= number_with_delimiter(product.price * plan_product.production_count) %>
            </td>
          </tr>
        <% end %>

        <!-- 合計行 -->
        <tr style="background-color: #e8e8e8; font-weight: bold;">
          <td colspan="3" style="border: 1px solid #999; padding: 8px;">合計</td>
          <td style="border: 1px solid #999; padding: 8px; text-align: right;">
            <%= number_with_delimiter(@plan_products.sum(&:production_count)) %> 点
          </td>
          <td style="border: 1px solid #999; padding: 8px;"></td>
          <td style="border: 1px solid #999; padding: 8px; text-align: right;">
            ¥<%= number_with_delimiter(@total_cost) %>
          </td>
        </tr>
      <% else %>
        <tr>
          <td colspan="6" style="border: 1px solid #999; padding: 20px; text-align: center; color: #999;">
            商品が登録されていません
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <!-- ページ区切り（画面では点線、印刷では次ページ） -->
  <div style="page-break-before: always; margin