<% product = local_assigns[:product] %>
<% all_materials = product.product_materials %>
<% material_categories = @material_categories %>

<%# タブナビゲーションの構造を新規作成画面と統一 %>
<nav>
  <div class="nav nav-tabs" id="materialTab" role="tablist">
    <%# Allタブ %>
    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#material-all" type="button" role="tab" aria-controls="material-all" aria-selected="true">
      <%= t('products.tab_all') %>
    </button>

    <%# カテゴリ別のタブ（商品に使用されているカテゴリのみ表示） %>
    <% used_category_ids = all_materials.map { |pm| pm.material&.category_id }.compact.uniq %>
    <% material_categories.select { |c| used_category_ids.include?(c.id) }.each do |category| %>
      <button class="nav-link" id="<%= category.id %>-tab" data-bs-toggle="tab" data-bs-target="#material-<%= category.id %>" type="button" role="tab" aria-controls="material-<%= category.id %>" aria-selected="false">
        <%= category.name %>
      </button>
    <% end %>
  </div>
</nav>

<%# タブの内容表示部分 %>
<div class="tab-content pt-3" id="materialTabContent">

    <%# Allタブの内容 %>
    <div class="tab-pane fade show active" id="material-all" role="tabpanel" aria-labelledby="all-tab">
      <%= render 'product_material_table', materials: all_materials %>
    </div>

    <%# カテゴリ別のタブの内容（商品に使用されているカテゴリのみ） %>
    <% used_category_ids = all_materials.map { |pm| pm.material&.category_id }.compact.uniq %>
    <% material_categories.select { |c| used_category_ids.include?(c.id) }.each do |category| %>
      <% filtered_materials = all_materials.select { |pm| pm.material.category_id == category.id } %>
        <div class="tab-pane fade" id="material-<%= category.id %>" role="tabpanel" aria-labelledby="<%= category.id %>-tab">
          <%= render 'product_material_table', materials: filtered_materials %>
        </div>
    <% end %>
</div>
