<%
  # ユニークIDの生成
  # 既存レコード: existing_{id}
  # 新規レコード: new_{object_id}
  unique_id = f.object.persisted? ? "existing_#{f.object.id}" : "new_#{f.object.object_id}"
  category_id ||= local_assigns[:category_id] || f.object.material&.category_id || 0

  # ALLタブ（category_id=0）の場合はすべての原材料を表示
  # それ以外は該当カテゴリの原材料のみ
  if category_id == 0
    materials = Material.order(:name)
  else
    materials = Material.where(category_id: category_id).order(:name)
  end

  # 商品単位重量を取得（product_materials.unit_weightから）
  unit_weight = f.object.unit_weight
  unit_weight_display = unit_weight && unit_weight > 0 ? (unit_weight.to_i == unit_weight ? unit_weight.to_i : unit_weight) : t('helpers.no_setting')
%>

<tr class="nested-fields"
    data-controller="form--nested-form-item resources--product-material--material"
    data-unique-id="<%= unique_id %>"
    data-category-id="<%= category_id %>">

  <%= f.hidden_field :_destroy, value: f.object.marked_for_destruction? ? 1 : 0,
                  data: { 'form--nested-form-item-target': 'destroy' } %>
  <%= f.hidden_field :id %>
  <%= f.hidden_field :unit_id,
                    value: f.object.unit_id || f.object.material&.unit_for_product_id,
                    data: { 'resources--product-material--material-target': 'unitIdInput' } %>

  <!-- 1. 原材料選択 -->
  <td>
    <%= f.collection_select(:material_id, materials, :id, :name,
      { include_blank: t('helpers.prompt.select') },
      { class: 'form-select',
        data: {
          action: 'change->resources--product-material--material#updateUnit change->resources--product-material--material#syncMaterialToOtherTabs',
          'resources--product-material--material-target': 'materialSelect',
          'unique-id': unique_id
        }
      }) %>
  </td>

    <!-- 2. 数量 -->
  <td>
    <%= f.number_field :quantity,
      class: 'form-control',
      min: 0,
      step: 'any',
      placeholder: t('helpers.forms.quantity_placeholder'),
      data: {
        'resources--product-material--material-target': 'quantityInput',
        action: 'input->resources--product-material--material#syncQuantityToOtherTabs',
        'unique-id': unique_id
      } %>
  </td>

  <!-- 3. 商品単位重量（入力フィールド） -->
  <td>
    <%= f.number_field :unit_weight,
      class: 'form-control',
      min: 0,
      step: 'any',
      placeholder: '重量を入力',
      data: {
        'resources--product-material--material-target': 'unitWeightInput',
        action: 'input->resources--product-material--material#syncUnitWeightToOtherTabs',
        'unique-id': unique_id
      } %>
  </td>

  <!-- 4. 単位 -->
  <td>
    <span data-resources--product-material--material-target="unitDisplay" class="fw-bold">
      <%= f.object.material&.unit_for_product&.name || t('helpers.no_setting') %>
    </span>
  </td>

  <!-- 5. 削除ボタン -->
  <td class="text-end">
    <button type="button"
            class="btn btn-sm btn-outline-danger"
            data-action="click->form--nested-form-item#remove"
            data-unique-id="<%= unique_id %>">
      <%= t('helpers.link.destroy') %>
    </button>
  </td>
</tr>
