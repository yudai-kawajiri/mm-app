<%
  # ユニークIDの生成
  # 既存レコード: existing_{id}
  # 新規レコード: new_{object_id}（Rubyのオブジェクト識別子、同じオブジェクトなら常に同じ値）
  unique_id = f.object.persisted? ? "existing_#{f.object.id}" : "new_#{f.object.object_id}"
  category_id ||= local_assigns[:category_id] || f.object.material&.category_id || 0
%>

<tr class="nested-fields"
    data-controller="nested-form-item product-material"
    data-unique-id="<%= unique_id %>"
    data-category-id="<%= category_id %>">

  <%= f.hidden_field :_destroy, value: f.object.marked_for_destruction? ? 1 : 0,
                    data: { 'nested-form-item-target': 'destroy' } %>
  <%= f.hidden_field :id %>
  <%= f.hidden_field :unit_id, data: { 'product-material-target': 'unitIdInput' } %>

  <% materials = Material.where(category_id: category_id).order(:name) %>

  <!-- 1. 原材料選択 -->
  <td>
    <%= f.collection_select(:material_id, materials, :id, :name,
      { include_blank: t('helpers.prompt.select') },
      { class: 'form-select',
        data: {
          action: 'change->product-material#updateUnit change->product-material#syncMaterialToOtherTabs',
          'product-material-target': 'materialSelect',
          'unique-id': unique_id
        }
      }) %>
  </td>

  <!-- 2. 数量 -->
  <td>
    <%= f.number_field :quantity,
      class: 'form-control',
      min: 0,
      placeholder: t('helpers.forms.quantity_placeholder'),
      data: {
        'product-material-target': 'quantityInput',
        action: 'input->product-material#syncQuantityToOtherTabs',
        'unique-id': unique_id
      } %>
  </td>

  <!-- 3. 商品単位重量 -->
  <td>
    <span data-product-material-target="unitWeightDisplay" class="form-control-plaintext">
      <%= f.object.material&.unit_weight_for_product || t('helpers.no_setting') %>
    </span>
  </td>

  <!-- 4. 単位 -->
  <td>
    <span data-product-material-target="unitDisplay" class="fw-bold">
      <%= f.object.material&.unit_for_product&.name || t('helpers.no_setting') %>
    </span>
  </td>

  <!-- 5. 削除ボタン -->
  <td class="text-end">
    <button type="button"
            class="btn btn-sm btn-outline-danger"
            data-action="click->nested-form-item#remove"
            data-unique-id="<%= unique_id %>">
      <%= t('helpers.link.destroy') %>
    </button>
  </td>
</tr>