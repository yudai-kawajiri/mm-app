<div data-controller="product-material nested-form category-tab-manager"
     data-product-material-target="totalContainer">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex justify-content-start align-items-center">
      <%= select_tag("category_selector",
          options_from_collection_for_select(@material_categories, :id, :name),
          {
            prompt: 'カテゴリを選択',
            class: 'form-select me-2',
            style: 'width: 250px;',
            data: {
              'category-tab-manager-target': 'categorySelector',
              'action': 'change->category-tab-manager#toggleButton'
            }
          }) %>

      <button type="button"
              class="btn btn-primary"
              data-action="category-tab-manager#showSelectedTab"
              data-category-tab-manager-target="showButton"
              disabled>
        カテゴリタブを追加
      </button>
    </div>
  </div>

  <!-- タブナビゲーション -->
  <div class="nav nav-tabs" role="tablist" data-category-tab-manager-target="tabNav">
    <!-- ALLタブ（削除不可） -->
    <button class="nav-link active"
            id="nav-0-tab"
            data-bs-toggle="tab"
            data-bs-target="#nav-0"
            type="button"
            role="tab"
            aria-controls="nav-0"
            aria-selected="true"
            data-category-id="0">
      全て
    </button>

    <!-- 既存カテゴリタブ（×ボタン付き） -->
    <% displayed_category_ids = @product.product_materials.map { |pm| pm.material&.category_id }.compact.uniq %>
    <% @material_categories.select { |c| displayed_category_ids.include?(c.id) }.each do |category| %>
      <button class="nav-link position-relative"
              id="nav-<%= category.id %>-tab"
              data-bs-toggle="tab"
              data-bs-target="#nav-<%= category.id %>"
              type="button"
              role="tab"
              aria-controls="nav-<%= category.id %>"
              aria-selected="false"
              data-category-id="<%= category.id %>"
              style="padding-right: 2.5rem;">
        <%= category.name %>
        <span class="position-absolute top-50 end-0 translate-middle-y pe-2"
              style="cursor: pointer; font-weight: bold; color: #dc3545;"
              data-action="click->category-tab-manager#removeTab"
              data-category-id="<%= category.id %>">
          ×
        </span>
      </button>
    <% end %>
  </div>

  <!-- タブコンテンツ -->
  <div class="tab-content pt-3" data-category-tab-manager-target="contentContainer">
    <!-- ALLタブコンテンツ -->
    <div class="tab-pane fade show active"
         id="nav-0"
         role="tabpanel"
         aria-labelledby="nav-0-tab"
         data-category-id="0">
      <%= render 'shared/material_category_tab_content',
          category_id: 0,
          category_name: 'すべて',
          product: @product,
          material_categories: @material_categories,
          f: f %>
    </div>

    <!-- 既存カテゴリタブコンテンツ -->
    <% @material_categories.select { |c| displayed_category_ids.include?(c.id) }.each do |category| %>
      <div class="tab-pane fade"
           id="nav-<%= category.id %>"
           role="tabpanel"
           aria-labelledby="nav-<%= category.id %>-tab"
           data-category-id="<%= category.id %>">
        <%= render 'shared/material_category_tab_content',
            category_id: category.id,
            category_name: category.name,
            product: @product,
            material_categories: @material_categories,
            f: f %>
      </div>
    <% end %>
  </div>

  <!-- テンプレート: タブボタン -->
  <template data-category-tab-manager-target="categoryTemplate">
    <button class="nav-link position-relative"
            id="nav-CATEGORY_ID_PLACEHOLDER-tab"
            data-bs-toggle="tab"
            data-bs-target="#nav-CATEGORY_ID_PLACEHOLDER"
            type="button"
            role="tab"
            aria-controls="nav-CATEGORY_ID_PLACEHOLDER"
            aria-selected="false"
            data-category-id="CATEGORY_ID_PLACEHOLDER"
            style="padding-right: 2.5rem;">
      CATEGORY_NAME_PLACEHOLDER
      <span class="position-absolute top-50 end-0 translate-middle-y pe-2"
            style="cursor: pointer; font-weight: bold; color: #dc3545;"
            data-action="click->category-tab-manager#removeTab"
            data-category-id="CATEGORY_ID_PLACEHOLDER">
        ×
      </span>
    </button>
  </template>

  <!-- テンプレート: タブコンテンツ -->
  <template data-category-tab-manager-target="categoryPaneTemplate">
    <div class="tab-pane fade"
         id="nav-CATEGORY_ID_PLACEHOLDER"
         role="tabpanel"
         aria-labelledby="nav-CATEGORY_ID_PLACEHOLDER-tab"
         data-category-id="CATEGORY_ID_PLACEHOLDER">

      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th style="width: 35%;">原材料名</th>
              <th style="width: 15%;">数量</th>
              <th style="width: 20%;">商品単位重量</th>
              <th style="width: 20%;">単位</th>
              <th style="width: 10%;" class="text-end">アクション</th>
            </tr>
          </thead>
          <tbody data-nested-form-target="target" data-category-id="CATEGORY_ID_PLACEHOLDER">
            <!-- 原材料行がここに追加される -->
          </tbody>
        </table>

        <div class="mt-3">
          <button type="button"
                  class="btn btn-outline-success w-100"
                  data-category-id="CATEGORY_ID_PLACEHOLDER"
                  data-template-id="product_material_fields_template_CATEGORY_ID_PLACEHOLDER"
                  data-action="click->nested-form#add">
            原材料を追加
          </button>
        </div>
      </div>
    </div>
  </template>

  <!-- 原材料行テンプレート（各カテゴリ用） -->
  <% @material_categories.each do |category| %>
    <template id="product_material_fields_template_<%= category.id %>" data-nested-form-target="template">
      <%= f.fields_for :product_materials,
          @product.product_materials.build(material: Material.new(category_id: category.id)),
          child_index: 'NEW_RECORD' do |material_f| %>
        <%= render 'product_material_fields', f: material_f, category_id: category.id %>
      <% end %>
    </template>
  <% end %>

</div>
