<div data-controller="nested-form">
  <h3><%= t('forms.titles.product_material') %></h3>

  <%# タブナビゲーションの追加 %>
  <nav>
    <div class="nav nav-tabs" id="material-nav-tab" role="tablist">
      <% @material_categories.each_with_index do |category, index| %>
        <button class="nav-link <%= index == 0 ? 'active' : '' %>"
                id="material-nav-<%= category.id %>-tab"
                data-bs-toggle="tab"
                data-bs-target="#material-nav-<%= category.id %>"
                type="button"
                role="tab"
                aria-controls="material-nav-<%= category.id %>"
                aria-selected="<%= index == 0 ? 'true' : 'false' %>">
          <%= category.name %>
        </button>
      <% end %>
    </div>
  </nav>

  <%# タブコンテンツの追加 %>
  <div class="tab-content pt-3" id="material-nav-tabContent">
    <% @material_categories.each_with_index do |category, index| %>
      <div class="tab-pane fade <%= index == 0 ? 'show active' : '' %>"
            id="material-nav-<%= category.id %>"
            role="tabpanel"
            aria-labelledby="material-nav-<%= category.id %>-tab">

        <%#フォームヘッダー %>
        <div class="row fw-bold mb-2 pb-1 border-bottom">
          <div class="col-md-4"><%= t('activerecord.attributes.material.name') %></div>
          <div class="col-md-2 text-center"><%= t('helpers.forms.quantity_placeholder') %></div>
          <div class="col-md-2"><%= t('activerecord.attributes.material.unit_weight_for_product') %></div>
          <div class="col-md-2"><%= t('activerecord.attributes.material.unit_for_product') %></div>
          <div class="col-md-2 text-end"><%= t('common.action') %></div>
        </div>

        <%# フォーム行の挿入ターゲット %>
        <div data-nested-form-target="target" data-category-id="<%= category.id %>">

          <%# タブで絞り込む %>
          <% f.object.product_materials.select { |pm| pm.material.present? && pm.material.category_id == category.id }.each do |product_material| %>
            <%= f.fields_for :product_materials, product_material, child_index: product_material.object_id do |material_f| %>
              <%= render 'product_material_fields', f: material_f %>
            <% end %>
          <% end %>

          <%# カテゴリIDを埋め込む %>
          <% if f.object.new_record? && index == 0 %>
            <%= f.fields_for :product_materials, f.object.product_materials.build(material: Material.new(category_id: category.id)), child_index: "initial_record" do |material_f| %>
              <%= render 'product_material_fields', f: material_f %>
            <% end %>
          <% end %>
        </div>

        <%# 新規追加ボタン %>
        <div class="d-grid mt-3">
          <button type="button" class="btn btn-sm btn-outline-success"
                      data-action="nested-form#add"
                      data-association="product_materials"
                      data-template-id="material_fields_template_<%= category.id %>"
                      data-category-id="<%= category.id %>">
            <%= t('helpers.link.add_item', resource: category.name) %>
          </button>
        </div>
      </div>
    <% end %>
  </div>

  <%# テンプレート定義  %>
  <% @material_categories.each do |category| %>
    <%= f.fields_for :product_materials,
                      f.object.product_materials.build(material: Material.new(category_id: category.id)),
                      child_index: 'NEW_RECORD' do |material_f| %>
      <template data-nested-form-target="template"
                id="material_fields_template_<%= category.id %>">
        <%= render 'product_material_fields', f: material_f %>
      </template>
    <% end %>
  <% end %>

</div>