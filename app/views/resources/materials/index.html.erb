<%# 原材料一覧画面 %>
<%= content_for(:title, t('materials.index.title')) %>

<div data-controller="sortable-table"
      data-sortable-table-reorder-path-value="<%= reorder_resources_materials_path %>"
      data-sortable-table-param-name-value="material">

  <%= render 'shared/layouts/header_with_actions',
      title: t('materials.index.title'),
      resource: nil,
      is_index_page: true,
      is_form_page: false,
      is_show_page: false,
      new_path: new_resources_material_path,
      sortable: true %>

  <%
    name_with_reading = Proc.new do |material|
      if material.reading.present?
        "#{material.name} <span class='text-muted small'>（#{material.reading}）</span>".html_safe
      else
        material.name
      end
    end
  %>

  <%= render 'shared/components/resource_list',
      resources: @materials,
      resource_class: Resources::Material,
      search_target: :category_id,
      search_categories: @material_categories,
      sort_options: [
        [t('materials.index.sort_options.display_order'), 'display_order'],
        [t('materials.index.sort_options.name'), 'reading'],
        [t('materials.index.sort_options.category'), 'category'],
        [t('materials.index.sort_options.order_group'), 'order_group'],
        [t('materials.index.sort_options.created_at'), 'created_at']
      ],
      sort_placeholder: t('materials.index.sort_placeholder'),
      icon_mode: true,
      sortable: true,

      columns: [
        { header: :name, data: name_with_reading },
        { header: :category,
          data: Proc.new { |material| material.category&.name || '-' }
        },
        { header: :default_unit_weight,
          data: Proc.new { |material|
            material.default_unit_weight.present? && material.default_unit_weight > 0 ?
              number_with_precision(material.default_unit_weight, precision: 1) :
              '-'
          }
        },
        { header: :unit_for_product,
          data: Proc.new { |material| material.unit_for_product&.name || '-' }
        },
        { header: :default_order_quantity,
          data: Proc.new { |material|
            if material.weight_based? && material.unit_weight_for_order.present?
              "#{number_with_precision(material.unit_weight_for_order, precision: 1)} #{t('units.gram')}"
            elsif material.count_based? && material.pieces_per_order_unit.present?
              "#{material.pieces_per_order_unit} #{material.unit_for_product&.name}"
            else
              '-'
            end
          }
        },
        { header: :unit_for_order,
          data: Proc.new { |material| material.unit_for_order&.name || '-' }
        },
        { header: :production_unit,
          data: Proc.new { |material| material.production_unit&.name || '-' }
        },
        { header: :order_group,
          data: Proc.new { |material| material.order_group&.name || '-' }
        }
      ]
  %>

  <%= paginate @materials, theme: 'bootstrap-5' %>
</div>
