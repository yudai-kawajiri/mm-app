<%#
  機能: 商品基本情報フォームフィールド
  - 商品名、売価、カテゴリ、ステータス、品番、画像、説明の入力フィールド
  - 画像プレビュー・削除機能付き
  - Stimulus Controller（image-preview）による画像管理
  - 新規作成・編集画面で使用

  必須引数:
  - f: FormBuilder - フォームビルダーオブジェクト

  修正内容:
  - ステータスとカテゴリーの順序を入れ替え
  - ステータス: 左カラムの3番目（売価の次）
  - カテゴリー: 右カラムの1番目（最初）
%>
<div class="card mb-3">
  <div class="card-header bg-light">
    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i><%= t('forms.titles.basic_info') %></h5>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <!-- 左カラム -->
      <div class="col-md-6">
        <!-- 1. 商品名 -->
        <%= form_group_lg(f, :name, wrapper_class: 'mb-3') %>

        <!-- 2. 売価 -->
        <%= form_group_lg(f, :price,
                          wrapper_class: 'mb-3',
                          field_type: :text_field,
                          prefix: t('number.currency.format.unit'),
                          inputmode: 'numeric',
                          data: {
                            controller: 'number-input',
                            action: 'input->number-input#handleInput paste->number-input#handlePaste'
                          }) %>

        <!-- 3. ステータス（ここに移動） -->
        <%= form_group_lg(f, :status,
                          field_type: :select,
                          wrapper_class: 'mb-3',
                          choices: Resources::Product.statuses.keys.map { |status| [t("activerecord.enums.resources/product.status.#{status}"), status] },
                          select_options: { include_blank: t('helpers.prompt.select') })
                          %>
      </div>

      <!-- 右カラム -->
      <div class="col-md-6">
        <!-- 1. カテゴリー（ここに移動） -->
        <%= form_group_lg(f, :category_id,
                          field_type: :collection_select,
                          wrapper_class: 'mb-3',
                          collection: @product_categories,
                          value_method: :id,
                          text_method: :name,
                          select_options: { include_blank: t('helpers.prompt.select')}) %>

        <!-- 2. 品番 -->
        <%= form_group_lg(f, :item_number,
                          wrapper_class: 'mb-3',
                          placeholder: t('products.placeholder.item_number'),
                          data: {
                            controller: 'number-input',
                            number_input_no_comma: 'true',
                            action: 'input->number-input#handleInput paste->number-input#handlePaste'
                          }) %>

        <!-- 3. 画像 -->
        <div class="mb-3" data-controller="image-preview">
          <%= form_label_lg(f, :image) %>

          <%= f.file_field :image,
              data: {
                image_preview_target: "input",
                action: "change->image-preview#handleFileSelect"
              },
              class: "d-none",
              accept: "image/*" %>

          <button type="button"
                  class="btn btn-outline-primary w-100"
                  onclick="this.previousElementSibling.click()">
            <i class="bi bi-upload me-2"></i>
            <% if f.object.persisted? && f.object.image.attached? %>
              <%= t('products.image_help.change') %>
            <% else %>
              <%= t('products.image_help.select') %>
            <% end %>
          </button>

          <% if f.object.errors[:image].any? %>
            <div class="invalid-feedback d-block">
              <%= f.object.errors[:image].first %>
            </div>
          <% end %>

          <div class="text-center mt-2 p-2 border rounded bg-light position-relative"
                style="height: 120px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
            <%
              show_existing_image = f.object.persisted? && f.object.image.attached?
              show_base64_preview = !f.object.persisted? && defined?(@image_preview_data) && @image_preview_data.present?
              show_any_image = show_existing_image || show_base64_preview
            %>

            <% if show_existing_image %>
              <%= image_tag f.object.image,
                    data: { image_preview_target: "preview" },
                    class: "position-relative",
                    style: "max-width: 100%; max-height: 110px; width: auto; height: auto; object-fit: contain; z-index: 2;" %>
            <% elsif show_base64_preview %>
              <%= image_tag "data:#{@image_content_type || 'image/png'};base64,#{@image_preview_data}",
                    data: { image_preview_target: "preview" },
                    class: "position-relative",
                    style: "max-width: 100%; max-height: 110px; width: auto; height: auto; object-fit: contain; z-index: 2;" %>
            <% else %>
              <%= image_tag '',
                    data: { image_preview_target: "preview" },
                    class: "position-relative",
                    style: "max-width: 100%; max-height: 110px; width: auto; height: auto; object-fit: contain; display: none; z-index: 2;" %>
            <% end %>

            <label data-image-preview-target="previewLabel"
                    class="position-absolute"
                    style="<%= show_any_image ? 'display: none;' : '' %> cursor: pointer; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1;">
              <span class="text-muted" style="font-size: 0.9em;"><%= t('products.image_help.no_image') %></span>
            </label>
          </div>

          <div class="text-center mt-2">
            <% if f.object.persisted? && f.object.image.attached? %>
              <div data-image-preview-target="currentImageContainer">
                <%= link_to t('helpers.link.delete_image'), "#",
                  data: {
                    product_id: f.object.id,
                    url: purge_image_resources_product_path(f.object),
                    action: "click->image-preview#deleteExistingImage"
                  },
                  class: "btn btn-sm btn-danger" %>
              </div>
            <% end %>

            <button type="button"
                    data-image_preview_target="cancelButton"
                    data-action="click->image-preview#cancelNewImage"
                    class="btn btn-sm btn-outline-danger"
                    style="display: none;">
              <%= t('helpers.link.cancel_new_image') %>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 説明欄（全幅） -->
    <div class="row mt-3">
      <div class="col-md-12">
        <div class="mb-3">
          <%= form_label_lg(f, :description) %>
          <%= f.text_area :description,
              class: "form-control",
              rows: 4,
              maxlength: 1000,
              data: {
                controller: "character-counter",
                character_counter_target: "input",
                character_counter_max_value: 1000,
                character_counter_warning_value: 20,
                character_counter_danger_value: 10,
                action: "input->character-counter#updateCount"
              } %>
          <div class="form-text d-flex justify-content-between align-items-center mt-1">
            <span><%= t('helpers.character_counter.hint', max: 1000) %></span>
            <span data-character-counter-target="counter" class="badge bg-secondary"></span>
          </div>
          <% if f.object.errors[:description].any? %>
            <div class="invalid-feedback d-block">
              <%= f.object.errors[:description].first %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
