<%# 商品一覧画面 %>
<%= content_for(:title, t('products.index.title')) %>

<div data-controller="sortable-table resource-search"
      data-sortable-table-reorder-path-value="<%= reorder_company_resources_products_path(company_slug: current_company.slug) %>"
      data-sortable-table-param-name-value="product_ids">

  <%= render 'shared/layouts/header_with_actions',
      title: t('products.index.title'),
      resource: nil,
      is_index_page: true,
      is_form_page: false,
      is_show_page: false,
      new_path: scoped_path(:new_resources_product_path),
      sortable: true %>

  <%
    name_with_reading = Proc.new do |product|
      if product.reading.present?
        "#{product.name} <span class='text-muted small'>（#{product.reading}）</span>".html_safe
      else
        product.name
      end
    end

    search_name = Proc.new do |product|
      if product.reading.present?
        "#{product.name} #{product.reading}"
      else
        product.name
      end
    end
  %>

  <%= render 'shared/components/resource_list',
      resources: @products,
      resource_class: Resources::Product,
      search_target: :category_id,
      search_categories: @product_categories,
      sort_options: [
        [t('products.index.sort_options.display_order'), 'display_order'],
        [t('products.index.sort_options.name'), 'name'],
        [t('products.index.sort_options.category'), 'category'],
        [t('products.index.sort_options.created_at'), 'created_at']
      ],
      sort_placeholder: t('products.index.sort_placeholder'),
      sortable: true,
      icon_mode: true,
      search_name_proc: search_name,

      columns: [
        {
          header: :image,
          data: Proc.new { |product|
            if product.image.attached?
              image_tag(product.image, class: 'img-thumbnail', style: 'max-width: 50px; max-height: 50px; object-fit: contain;')
            else
              content_tag(:span, t('products.image_help.no_image'), class: 'text-muted')
            end
          }
        },
        { header: :name, data: name_with_reading },
        { header: :category_id,
          data: Proc.new { |product| product.category&.name }
        },
        { header: :item_number, data: :item_number },
        { header: :price, data: :price },
        { header: :status,
          data: Proc.new { |product| render_product_status_with_action(product) }
        }
      ]
  %>

  <%= paginate @products, theme: 'bootstrap-5' %>
</div>
