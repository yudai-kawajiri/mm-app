<% plan = local_assigns[:plan] %>
<% f = local_assigns[:f] %>
<% category_id = local_assigns[:category_id].to_i %>
<% category_name = local_assigns[:category_name] %>

<% current_plan_products = category_id == 0 ?
    plan.plan_products.reject(&:marked_for_destruction?) :
    plan.plan_products.select { |pp| pp.product&.category_id == category_id && !pp.marked_for_destruction? } %>

<div class="table-responsive">
  <table class="table table-striped">
    <thead>
      <tr>
        <th style="width: 35%;">商品名</th>
        <th style="width: 15%;">数量</th>
        <th style="width: 20%;" class="text-end">売価</th>
        <th style="width: 20%;" class="text-end">小計</th>
        <th style="width: 10%;" class="text-end">アクション</th>
      </tr>
    </thead>
    <tbody data-nested-form-target="target" data-category-id="<%= category_id %>">
      <% current_plan_products.each do |plan_product| %>
        <%= f.fields_for :plan_products, plan_product do |ff| %>
          <%= render 'plan_product_fields', f: ff, category_id: category_id %>
        <% end %>
      <% end %>
    </tbody>
  </table>

  <!-- ALLタブでは商品追加ボタンを非表示 -->
  <% if category_id != 0 %>
    <div class="mt-3">
      <button type="button"
              class="btn btn-outline-success w-100"
              data-category-id="<%= category_id %>"
              data-template-id="plan_product_fields_template_<%= category_id %>"
              data-action="click->nested-form#add">
        商品を追加
      </button>
    </div>

    <!-- カテゴリ合計 -->
    <div class="text-end mt-3 fw-bold">
      カテゴリ合計:
      <span data-plan-product-target="categoryTotal" data-category-id="<%= category_id %>">¥0</span>
    </div>
  <% end %>
</div>
