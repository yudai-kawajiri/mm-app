<%# /home/user/workspace/mm-app/app/views/shared/_plan_products_category_tab_content.html.erb %>
<%# å—ã‘å–ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°: category_id, category_name, plan_products, product_categories %>

<%# plan_products å¤‰æ•°ã®ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°åŒ– %>
<% plan_product = local_assigns[:plan_product] %>

<%# ðŸ’¡ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯: ç¾åœ¨ã®ã‚¿ãƒ–IDã«åŸºã¥ã„ã¦å•†å“ä¸€è¦§ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° %>
<% current_products = category_id.to_i == 0 ? plan_products.products.reject(&:marked_for_destruction?) : plan_products.products.select { |p| p.category_id == category_id && !p.marked_for_destruction? } %>

<div class="mb-3">
    <%# 1. ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ (å•†å“è¨ˆç”»ç”¨) %>
    <div class="row fw-bold mb-2 pb-1 border-bottom">
      <div class="col-md-4"><%= t('activerecord.attributes.product.name') %></div>
      <div class="col-md-2"><%= t('activerecord.attributes.plan_products.target_quantity') %></div>
      <div class="col-md-2 text-end"><%= t('activerecord.attributes.product.cost') %></div>
      <div class="col-md-2 text-end"><%= t('common.subtotal') %></div>
      <div class="col-md-2"></div>
    </div>

    <%# 2. æ—¢å­˜ã®å•†å“è¡Œã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° %>
    <div data-nested-form-target="links">
      <% current_products.each do |product| %>
        <%# ãƒã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®å±žæ€§ã‚’ plan_products[products_attributes] ã«è¨­å®š %>
        <%= fields_for "plan_products[products_attributes][]", product do |f| %>
          <%= render 'shared/plan_products_item_form', f: f %>
        <% end %>
      <% end %>
    </div>

    <%# 3. å•†å“ã‚’è¿½åŠ ãƒœã‚¿ãƒ³ %>
    <div class="mt-3">
      <%# ãƒªã‚½ãƒ¼ã‚¹åã‚’ :products ã«è¨­å®š %>
      <%= link_to_add_association t('plans.add_product_to_category', name: category_name),
            :products,
            data: {
              target: 'nested-form.add_item',
              'nested-form-target': 'add',
              'nested-form-wrapper-selector': '.row',
              'category-id': category_id # æ–°è¦è¿½åŠ æ™‚ã«ã‚«ãƒ†ã‚´ãƒªIDã‚’æ¸¡ã™
            },
            class: 'btn btn-outline-secondary btn-sm' %>
    </div>

</div>

<%# 4. ãƒã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (<template> ã‚¿ã‚°) %>
<template data-nested-form-target="template" data-category-id="<%= category_id %>">
  <%# ãƒã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®å±žæ€§ã‚’ plan_products[products_attributes][new_records] ã«è¨­å®š %>
  <%= fields_for "plan_products[products_attributes][new_records]", Product.new, child_index: 'NEW_RECORD' do |f| %>
    <%= render 'shared/plan_products_item_form', f: f %>
  <% end %>
</template>