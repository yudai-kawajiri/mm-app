<%# リソースフォーム %>
<%#
  機能:
  - 統一されたリソースフォームテンプレート
  - New/Edit ページで共通して使用
  - フォームバリデーションと二重送信防止機能付き

  必須引数:
  - resource: フォーム対象のモデルインスタンス
  - form_title: ページタイトル

  オプション引数:
  - scope: ルーティングのスコープ（例: :admin）

  Stimulusコントローラー:
  - form-validation: フォームバリデーション
  - form--submit: 二重送信防止
%>
<% scope = local_assigns[:scope] %>

<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h2 class="mb-0"><%= form_title %></h2>
    </div>

    <div class="card-body">
      <%= render 'shared/forms/error_messages', resource: resource %>

      <% 
        model_for_form = scope.present? ? [scope, resource] : resource 
        if resource.new_record?
          if scope.present?
            form_url = scoped_path("#{Array(scope).join('_')}_#{resource.class.model_name.route_key}_path".to_sym)
          else
            form_url = scoped_path("#{resource.class.model_name.route_key}_path".to_sym)
          end
        else
          if scope.present?
            form_url = scoped_path("#{Array(scope).join('_')}_#{resource.class.model_name.route_key.singularize}_path".to_sym, resource)
          else
            form_url = scoped_path("#{resource.class.model_name.route_key.singularize}_path".to_sym, resource)
          end
        end
      %>
      <%= form_with(
            model: model_for_form,
            url: form_url,
            local: true,
            class: "needs-validation",
            data: {
              controller: "form-validation form--submit",
              action: "submit->form-validation#validate submit->form--submit#disableSubmit",
              form__submit_target: "form"
            }
          ) do |f| %>
        <% # scopeがある場合は scope/model_name/_fields.html.erb を探す %>
        <% fields_partial = scope.present? ? "#{scope}/#{resource.class.model_name.route_key}/fields" : resource_partial_path(resource, 'fields') %>
        <%= render fields_partial, f: f, resource: resource %>
        <%= render 'shared/actions/form_action_links', f: f, resource: resource, scope: scope %>
      <% end %>
    </div>
  </div>
</div>
