<%# リソースヘッダーアクション

    各画面（一覧/詳細/フォーム）に応じたアクションボタンを表示

    【マルチテナント対応】
    一覧画面の新規登録ボタンは can_register? で制御
    会社管理者が「全店舗」選択中は非表示となり、store_id=nil での登録を防止
%>
<% if is_form_page %>

  <%= render 'shared/actions/back_link',
              url: :back,
              custom_class: 'me-2' %>

  <% if params[:action] == 'new' || params[:action] == 'create' %>
    <%= button_tag type: 'button',
                    class: 'btn btn-sm btn-primary',
                    id: 'header_register_button' do %>
      <i class="bi bi-check-circle me-1"></i>
      <%= t('helpers.submit.create') %>
    <% end %>
  <% elsif params[:action] == 'edit' || params[:action] == 'update' %>
    <%= button_tag type: 'button',
                    class: 'btn btn-sm btn-primary',
                    id: 'header_register_button' do %>
      <i class="bi bi-check-circle me-1"></i>
      <%= t('helpers.submit.update') %>
    <% end %>
  <% end %>

  <script>
  function initializeHeaderButton() {
    const headerBtn = document.getElementById('header_register_button');

    if (!headerBtn) {
      return;
    }

    const newHeaderBtn = headerBtn.cloneNode(true);
    headerBtn.parentNode.replaceChild(newHeaderBtn, headerBtn);

    newHeaderBtn.addEventListener('click', function(e) {
      e.preventDefault();

      const form = document.getElementById('plan_form') ||
                    document.getElementById('product_form') ||
                    document.querySelector('form');

      if (form) {
        let submitBtn = document.getElementById('plan_submit_button') ||
                        document.getElementById('product_submit_button') ||
                        form.querySelector('input[type=submit]');

        if (submitBtn) {
          submitBtn.click();
        } else {
          try {
            if (typeof form.requestSubmit === 'function') {
              form.requestSubmit();
            } else {
              form.submit();
            }
          } catch (error) {
            console.error('requestSubmit failed, using form.submit():', error);
            form.submit();
          }
        }
      } else {
        console.error('ERROR: Form not found');
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeHeaderButton);
  } else {
    initializeHeaderButton();
  }

  document.addEventListener('turbo:load', initializeHeaderButton);
  </script>

<% elsif is_show_page %>

  <%
    index_path = polymorphic_path(resource.class)
  %>
  <%= render 'shared/actions/back_link',
              url: index_path,
              custom_class: 'me-2' %>

  <% if can_register? %>
    <%= render 'shared/actions/edit_link',
                url: edit_polymorphic_path(resource),
                custom_class: 'me-2' %>

    <%= render 'shared/actions/delete_link',
                url: resource,
                resource_name: resource.class.model_name.human %>
  <% end %>

<% elsif is_index_page %>

  <% if new_path.present? %>
    <%# マルチテナント: 会社管理者が「全店舗」選択中は新規登録ボタンを非表示 %>
    <% if can_register? %>
      <%= render 'shared/actions/new_link',
                  url: new_path,
                  custom_class: 'btn-sm' %>
    <% end %>
  <% else %>
    <%
      if defined?(resource) && resource
        resource_name = resource.class.model_name.singular_route_key.to_sym
        fallback_new_path = polymorphic_path([:new, resource_name])
      else
        fallback_new_path = '#'
      end
    %>
    <% if can_register? %>
      <%= render 'shared/actions/new_link',
                  url: fallback_new_path,
                  custom_class: 'btn-sm' %>
    <% end %>
  <% end %>

<% end %>
