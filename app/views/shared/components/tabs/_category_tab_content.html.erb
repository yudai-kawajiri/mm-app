<%# app/views/shared/components/tabs/_category_tab_content.html.erb %>
<%#
  汎用カテゴリタブコンテンツ - ネストフォーム統合版
  
  使用箇所:
  - 製造計画の商品選択タブ
  - 商品の原材料選択タブ
  
  必須locals:
  - category_id: カテゴリID（0=全て表示）
  - items: 表示するアイテムのコレクション
  - form_builder: フォームビルダー (f)
  - association_name: :plan_products または :product_materials
  - item_partial: 行パーシャル名 ('plan_product_fields' または 'product_material_fields')
  - table_headers: テーブルヘッダーのHTML（ブロックまたは文字列）
  - add_button_text: 追加ボタンのテキスト
  
  オプションlocals:
  - show_category_total: カテゴリ合計を表示するか（デフォルト: false）
  - total_target: 合計表示のdata-target属性
%>

<%
  category_id = local_assigns[:category_id].to_i
  items = local_assigns[:items]
  form_builder = local_assigns[:form_builder] || local_assigns[:f]
  association_name = local_assigns[:association_name]
  item_partial = local_assigns[:item_partial]
  table_headers = local_assigns[:table_headers]
  add_button_text = local_assigns[:add_button_text]
  show_category_total = local_assigns.fetch(:show_category_total, false)
  total_target = local_assigns[:total_target]
%>

<div class="table-responsive">
  <table class="table table-striped">
    <thead>
      <%= table_headers.html_safe %>
    </thead>
    <tbody data-form--nested-form-target="target" data-category-id="<%= category_id %>">
      <% items.each do |item| %>
        <%= form_builder.fields_for association_name, item do |ff| %>
          <%= render item_partial, f: ff, category_id: category_id %>
        <% end %>
      <% end %>
    </tbody>
  </table>

  <%# category_id が 0（ALLタブ）でない場合のみ追加ボタンとカテゴリ合計を表示 %>
  <% if category_id != 0 %>
    <div class="mt-3">
      <button type="button"
              class="btn btn-outline-success w-100"
              data-category-id="<%= category_id %>"
              data-template-id="<%= item_partial.gsub('_fields', '') %>_fields_template_<%= category_id %>"
              data-action="click->form--nested-form#add">
        <%= add_button_text %>
      </button>
    </div>

    <% if show_category_total && total_target.present? %>
      <div class="text-end mt-3 fw-bold">
        カテゴリ合計:
        <span data-<%= total_target %>="categoryTotal" data-category-id="<%= category_id %>">¥0</span>
      </div>
    <% end %>
  <% end %>
</div>
