<%# 検索フォーム %>
<%#
  機能:
  - リソースの検索・絞り込みフォーム
  - カテゴリー絞り込み + 名前検索
  - クリアボタン付き

  必須引数:
  - form_path: フォーム送信先のパス

  オプション引数:
  - search_target: 検索対象フィールド (:category_type, :category, :category_id)
  - search_categories: カテゴリー一覧（search_target が :category_id の場合）
  - resource_class: リソースクラス（enum翻訳用）
%>
<%= form_with url: form_path,
                    method: :get,
                    local: true,
                    class: "mb-3" do |f| %>

  <div class="d-flex flex-row align-items-center">
    <% if defined?(search_target) && search_target %>
      <div class="p-1 me-3"  style="min-width: 200px;">
        <% if search_target == :category_type %>
          <%# リソースクラスを取得（デフォルトは Resources::Category） %>
          <% resource_class_for_enum = local_assigns[:resource_class] || Resources::Category %>
          <%= f.select :category_type,
              options_for_select(
                resource_class_for_enum.category_types.keys.map { |k|
                  [I18n.t("activerecord.enums.#{resource_class_for_enum.model_name.i18n_key}.category_type.#{k}"), k]
                },
                params[:category_type]
              ),
              { include_blank: t('search.placeholders.select_type') },
              { class: "form-control custom-select" } %>

        <% elsif search_target == :category %>
          <%# Unitの場合 %>
          <%= f.select :category,
              options_for_select(
                Resources::Unit.categories.keys.map { |k|
                  [I18n.t("activerecord.enums.resources/unit.category.#{k}"), k]
                },
                params[:category]
              ),
              { include_blank: t('search.placeholders.select_type') },
              { class: "form-control custom-select" } %>

        <% elsif search_target == :category_id %>
          <% search_categories = local_assigns[:search_categories] %>
          <%= f.select :category_id,
              options_from_collection_for_select(
              search_categories || [],
              :id,
              :name,
              params[:category_id]
            ),
            { include_blank: t('search.placeholders.select_category') },
            { class: "form-control custom-select" } %>
        <% end %>
      </div>
    <% end %>

    <div class="p-1" style="min-width: 300px;">
      <div class="input-group">
        <%= f.text_field :q,
          value: params[:q],
          class: "form-control",
          placeholder: t('search.placeholders.enter_name') %>
        <div class="input-group-append" >
          <%= f.submit t('common.search'), class: "btn btn-primary" %>
          <% if params[:q].present? || params[:category_type].present? || params[:category_id].present? || params[:category].present? %>
            <%= link_to t('common.clear'), form_path,  class: "btn btn-outline-secondary" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>
