<%# 検索フォーム %>
<%= form_with url: form_path,
              method: :get,
              html: {
                class: "mb-3"
              } do |f| %>

  <div class="d-flex flex-row align-items-end">
    <% if local_assigns[:sort_options].present? %>
      <div class="p-1 me-3" style="min-width: 250px;">
        <label class="form-label mb-1 small text-muted"><%= t('common.sort_by') %></label>
        <%= f.select :sort_by,
              options_for_select(
                sort_options,
                params[:sort_by]
              ),
              { include_blank: t('helpers.prompt.select') },
              { class: "form-select", onchange: "this.form.requestSubmit()" } %>
      </div>
    <% end %>

    <% if defined?(search_target) && search_target %>
      <div class="p-1 me-3"  style="min-width: 250px;">
        <label class="form-label mb-1 small text-muted"><%= t('common.category') %></label>
        <% if search_target == :category_type %>
          <% resource_class_for_enum = local_assigns[:resource_class] || Resources::Category %>
          <%= f.select :category_type,
              options_for_select(
                resource_class_for_enum.category_types.keys.map { |k|
                  [I18n.t("activerecord.enums.#{resource_class_for_enum.model_name.i18n_key}.category_type.#{k}"), k]
                },
                params[:category_type]
              ),
              { include_blank: t('helpers.prompt.select') },
              { class: "form-select", onchange: "this.form.requestSubmit()" } %>

        <% elsif search_target == :category %>
          <%= f.select :category,
              options_for_select(
                Resources::Unit.categories.keys.map { |k|
                  [I18n.t("activerecord.enums.resources/unit.category.#{k}"), k]
                },
                params[:category]
              ),
              { include_blank: t('helpers.prompt.select') },
              { class: "form-select", onchange: "this.form.requestSubmit()" } %>

        <% elsif search_target == :category_id %>
          <% search_categories = local_assigns[:search_categories] %>
          <%= f.select :category_id,
              options_from_collection_for_select(
              search_categories || [],
              :id,
              :name,
              params[:category_id]
            ),
            { include_blank: t('helpers.prompt.select') },
            { class: "form-select", onchange: "this.form.requestSubmit()" } %>
        <% end %>
      </div>
    <% end %>

    <div class="p-1" style="min-width: 300px;">
      <label class="form-label mb-1 small text-muted"><%= t('common.name') %></label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <%= f.text_field :q,
          value: params[:q],
          class: "form-control",
          placeholder: (local_assigns[:search_placeholder] || t('search.placeholders.enter_name')),
          autocomplete: "off",
          data: {
            resource_search_target: "input",
            action: "input->resource-search#search keydown->resource-search#search"
          } %>
      </div>
    </div>

    <%
      has_params = params[:q].present? || params[:category_type].present? ||
                   params[:category_id].present? || params[:category].present? ||
                   params[:sort_by].present?
    %>

    <div class="p-1 <%= 'd-none' unless has_params %>"
         data-resource-search-target="clearButton">
      <label class="form-label mb-1 small text-muted">&nbsp;</label>
      <%= link_to t('common.clear'),
          form_path,
          class: "btn btn-outline-secondary d-block",
          data: {
            action: "click->resource-search#clear",
            turbo: false
          } %>
    </div>
  </div>
<% end %>
