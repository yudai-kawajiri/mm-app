#!/usr/bin/env bash
set -e

echo "=========================================="
echo "UUID移行チェック..."
echo "=========================================="

# companiesテーブルが存在し、かつIDがbigintの場合のみDBを再作成する
SHOULD_RESET=$(bundle exec rails runner "
  if ActiveRecord::Base.connection.table_exists?('companies')
    column = ActiveRecord::Base.connection.columns('companies').find { |c| c.name == 'id' }
    if column && column.sql_type.include?('bigint')
      puts 'true'
    else
      puts 'false'
    end
  else
    puts 'false'
  end
")

if [ "$SHOULD_RESET" = "true" ]; then
  echo "bigint型のテーブルを検出。UUID移行のためDB再作成..."
  DISABLE_DATABASE_ENVIRONMENT_CHECK=1 bundle exec rails db:drop db:create
  echo "データベースを再作成しました"
else
  echo "DB再作成の必要はありません（UUID対応済み、または新規環境です）"
fi

echo "=========================================="
echo "マイグレーションを実行中..."
echo "=========================================="
bundle exec rails db:migrate

echo "=========================================="
echo "シード処理を開始します..."
echo "=========================================="
bundle exec rails db:seed

echo "=========================================="
echo "デプロイ後処理完了"
echo "=========================================="

# Puma を起動
exec bundle exec puma -C config/puma.rb
